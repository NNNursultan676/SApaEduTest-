{% extends "base.html" %}

{% block title %}Аналитика - Sapa Edu{% endblock %}

{% block extra_head %}
<!-- Мобильная адаптация -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<!-- Chart.js для графиков -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
/* Mobile-First Analytics Styles */
@media (max-width: 768px) {
    /* Reset mobile styles */
    .navbar,
    .container-fluid > .row:first-child,
    header,
    .top-header,
    .sidebar {
        display: none !important;
    }

    /* Force full mobile layout */
    .container-fluid {
        padding: 0 !important;
        margin: 0 !important;
        max-width: 100% !important;
    }

    .col-xl-9, .col-lg-8 {
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
    }

    body {
        background: #f8fafc !important;
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif !important;
        line-height: 1.5 !important;
        font-size: 16px !important;
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    main {
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    .container-fluid {
        padding: 0 !important;
        margin: 0 !important;
    }

    /* Mobile Analytics Dashboard */
    .mobile-analytics-dashboard {
        min-height: 100vh;
        background: #f8fafc;
        padding: 0;
        position: relative;
    }

    /* Analytics Header */
    .analytics-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 1rem 1.5rem;
        border-radius: 0 0 24px 24px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .analytics-header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .analytics-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .analytics-avatar {
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .analytics-details {
        flex: 1;
    }

    .analytics-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        line-height: 1.2;
    }

    .analytics-subtitle {
        font-size: 0.875rem;
        margin: 0;
        opacity: 0.8;
    }

    .analytics-welcome {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        text-align: right;
    }

    .analytics-welcome-text {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
        line-height: 1.2;
    }

    .analytics-welcome-subtext {
        font-size: 0.8rem;
        opacity: 0.8;
        margin: 0;
        line-height: 1.2;
    }

    /* Overview Stats */
    .overview-stats {
        padding: 0 1rem;
        margin-bottom: 1.5rem;
    }

    .overview-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    .overview-stat {
        background: white;
        border-radius: 16px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.05);
        text-align: center;
    }

    .overview-stat-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.125rem;
        margin: 0 auto 0.5rem;
    }

    .overview-stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .overview-stat-icon.courses { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .overview-stat-icon.certificates { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .overview-stat-icon.companies { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }

    .overview-stat-number {
        font-size: 1.5rem;
        font-weight: 800;
        color: #111827;
        line-height: 1;
        margin-bottom: 0.25rem;
    }

    .overview-stat-label {
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 500;
    }

    /* Charts Section */
    .charts-section {
        margin-bottom: 1.5rem;
    }

    .chart-card {
        background: white;
        border-radius: 16px;
        margin: 0 1rem 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    .chart-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chart-controls {
        display: flex;
        gap: 0.5rem;
    }

    .chart-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
    }

    .chart-container {
        padding: 1rem;
        position: relative;
        height: 250px;
    }

    /* Export Section */
    .export-section {
        margin-bottom: 1.5rem;
    }

    .export-card {
        background: white;
        border-radius: 16px;
        margin: 0 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1rem;
    }

    .export-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .export-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    .export-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        padding: 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }

    .export-btn:active {
        transform: scale(0.98);
    }

    .export-btn.excel {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .export-btn.pdf {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .export-btn.csv {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    /* Course Analytics Section */
    .course-analytics-section {
        margin-bottom: 1.5rem;
    }

    .analytics-section-header {
        padding: 0 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .analytics-section-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .analytics-section-icon {
        color: #667eea;
    }

    /* Course Cards */
    .course-analytics-card {
        background: white;
        border-radius: 16px;
        margin: 0 1rem 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    .course-analytics-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .course-analytics-title {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
        margin: 0 0 0.5rem 0;
        line-height: 1.3;
    }

    .course-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    .course-metric {
        text-align: center;
        padding: 0.5rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #f3f4f6;
    }

    .course-metric-number {
        font-size: 1.125rem;
        font-weight: 700;
        margin-bottom: 0.125rem;
    }

    .course-metric-number.completed { color: #10b981; }
    .course-metric-number.progress { color: #3b82f6; }
    .course-metric-number.total { color: #6b7280; }

    .course-metric-label {
        font-size: 0.7rem;
        color: #6b7280;
        font-weight: 500;
    }

    .course-analytics-content {
        padding: 1rem;
    }

    .course-progress-bar {
        background: #f3f4f6;
        border-radius: 20px;
        height: 6px;
        margin: 0.75rem 0;
        overflow: hidden;
    }

    .course-progress-fill {
        height: 100%;
        border-radius: 20px;
        background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        transition: width 0.8s ease;
    }

    .course-completion-rate {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .completion-rate-label {
        font-size: 0.875rem;
        color: #374151;
        font-weight: 500;
    }

    .completion-rate-value {
        font-size: 0.875rem;
        font-weight: 700;
        color: #10b981;
    }

    .students-toggle {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        color: #374151;
        font-weight: 500;
        width: 100%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: background 0.2s ease;
    }

    .students-toggle:active {
        background: #e5e7eb;
    }

    .students-list {
        margin-top: 0.75rem;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .students-list.active {
        max-height: 500px;
    }

    .student-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .student-item:last-child {
        border-bottom: none;
    }

    .student-avatar {
        width: 36px;
        height: 36px;
        background: #3b82f6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.75rem;
    }

    .student-info {
        flex: 1;
    }

    .student-name {
        font-size: 0.875rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.125rem;
        line-height: 1.2;
    }

    .student-progress-bar {
        background: #f3f4f6;
        border-radius: 20px;
        height: 3px;
        margin: 0.25rem 0;
        overflow: hidden;
    }

    .student-progress-fill {
        height: 100%;
        border-radius: 20px;
        transition: width 0.8s ease;
    }

    .student-progress-text {
        font-size: 0.7rem;
        color: #6b7280;
        font-weight: 500;
    }

    .student-status {
        margin-left: 0.5rem;
        display: flex;
        align-items: center;
    }

    .student-status-badge {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
    }

    .student-status-badge.completed {
        background: #10b981;
        color: white;
    }

    .student-status-badge.progress {
        background: #3b82f6;
        color: white;
    }

    /* Company Analytics */
    .company-analytics-section {
        margin-bottom: 1.5rem;
    }

    .company-analytics-grid {
        padding: 0 1rem;
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .company-analytics-card {
        background: white;
        border-radius: 16px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .company-name {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
        margin: 0 0 0.75rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .company-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.875rem;
    }

    .company-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .company-metric {
        text-align: center;
    }

    .company-metric-number {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 0.125rem;
    }

    .company-metric-number.employees { color: #3b82f6; }
    .company-metric-number.active { color: #10b981; }
    .company-metric-number.certificates { color: #f59e0b; }

    .company-metric-label {
        font-size: 0.7rem;
        color: #6b7280;
        font-weight: 500;
    }

    .company-activity-bar {
        background: #f3f4f6;
        border-radius: 20px;
        height: 6px;
        overflow: hidden;
        margin-top: 0.75rem;
    }

    .activity-progress-fill {
        height: 100%;
        border-radius: 20px;
        background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        transition: width 0.8s ease;
    }

    .activity-rate {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
    }

    .activity-label {
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 500;
    }

    .activity-percentage {
        font-size: 0.75rem;
        font-weight: 700;
        color: #10b981;
    }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: #6b7280;
    }

    .empty-icon {
        width: 60px;
        height: 60px;
        background: #f3f4f6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #9ca3af;
        margin: 0 auto 1rem;
    }

    .empty-state h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        margin: 0 0 0.5rem 0;
    }

    .empty-state p {
        font-size: 0.875rem;
        margin: 0;
        line-height: 1.4;
    }

    /* Bottom Spacing */
    .bottom-spacing {
        height: 2rem;
    }

    /* Period Filter Buttons */
    .period-filter {
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .period-btn {
        background: #e5e7eb;
        color: #6b7280;
        border: none;
        padding: 0.5rem 0.8rem;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
    }

    .period-btn.active {
        background: #3b82f6;
        color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 360px) {
        .overview-grid {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .course-metrics,
        .company-metrics {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .analytics-title {
            font-size: 1.125rem;
        }

        .period-filter {
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }

        .period-btn {
            padding: 0.4rem 0.6rem;
            font-size: 0.7rem;
        }
    }

    /* Override desktop styles */
    .glass-card,
    .card-modern,
    .stat-card,
    .course-analytics,
    .circular-progress {
        all: unset !important;
        display: none !important;
    }

    /* Home button style for mobile analytics header */
    .analytics-home-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 0.75rem;
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        transition: all 0.2s ease;
    }

    .analytics-home-btn:hover,
    .analytics-home-btn:active {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        text-decoration: none;
        transform: scale(0.95);
    }
}

/* Desktop Styles */
@media (min-width: 769px) {
    .mobile-analytics-dashboard {
        display: none;
    }

    /* Enhanced desktop styles */
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);

        --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --card-shadow-hover: 0 20px 60px rgba(0, 0, 0, 0.15);
        --border-radius: 20px;
        --border-radius-lg: 25px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

        --glass-bg: rgba(255, 255, 255, 0.95);
        --glass-border: rgba(255, 255, 255, 0.3);
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .glass-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
        opacity: 0.8;
    }

    .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
    }

    .sidebar {
        background: var(--glass-bg);
        backdrop-filter: blur(30px);
        border-radius: var(--border-radius-lg);
        border: 1px solid var(--glass-border);
        box-shadow: var(--card-shadow);
        padding: 2rem;
        position: sticky;
        top: 120px;
        max-height: calc(100vh - 140px);
        overflow-y: auto;
    }

    .sidebar-item {
        display: flex;
        align-items: center;
        padding: 1rem 1.25rem;
        margin: 0.5rem 0;
        border-radius: 15px;
        text-decoration: none;
        color: #64748b;
        font-weight: 500;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .sidebar-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 0;
        background: var(--primary-gradient);
        transition: width 0.3s ease;
        z-index: -1;
    }

    .sidebar-item:hover {
        color: white;
        transform: translateX(5px);
    }

    .sidebar-item:hover::before {
        width: 100%;
    }

    .sidebar-item.active {
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .stat-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--border-radius);
        padding: 2rem;
        text-align: center;
        transition: var(--transition);
        cursor: pointer;
        position: relative;
        overflow: hidden;
        height: 160px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        transition: var(--transition);
    }

    .stat-card.primary::before { background: var(--primary-gradient); }
    .stat-card.success::before { background: var(--success-gradient); }
    .stat-card.secondary::before { background: var(--secondary-gradient); }
    .stat-card.warning::before { background: var(--warning-gradient); }

    .stat-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--card-shadow-hover);
    }

    .stat-number {
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1;
    }

    .stat-label {
        font-size: 1rem;
        color: #64748b;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .course-analytics {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
    }

    .course-analytics:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-shadow-hover);
    }

    .circular-progress {
        border-radius: 50%;
        position: relative;
        width: 100px;
        height: 100px;
        background: conic-gradient(var(--bs-success) 0deg, #e9ecef 0deg);
    }

    .circular-progress::before {
        content: '';
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        bottom: 10px;
        background: white;
        border-radius: 50%;
    }

    .card-modern {
        background: var(--glass-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        border: 1px solid var(--glass-border);
        transition: var(--transition);
    }

    .card-modern:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
    }

    /* Desktop Charts */
    .desktop-chart-container {
        height: 400px;
        position: relative;
    }

    /* Advanced Desktop Charts */
    .advanced-chart-container {
        height: 500px;
        position: relative;
        background: var(--glass-bg);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .chart-legend-custom {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 10px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }

    .chart-controls-desktop {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .chart-btn-desktop {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
    }

    .chart-btn-desktop:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .export-controls-desktop {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .export-btn-desktop {
        background: var(--success-gradient);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .export-btn-desktop:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
    }

    .export-btn-desktop.excel {
        background: var(--success-gradient);
    }

    .export-btn-desktop.pdf {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }

    .export-btn-desktop.csv {
        background: var(--warning-gradient);
    }

    /* Period Filter Buttons */
    .period-filter-desktop {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 2rem;
        padding: 1rem 1.5rem;
        background: var(--glass-bg);
        border-radius: var(--border-radius);
        border: 1px solid var(--glass-border);
        box-shadow: var(--card-shadow);
    }

    .period-btn-desktop {
        background: #e5e7eb;
        color: #6b7280;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
    }

    .period-btn-desktop:hover {
        background: #d1d5db;
    }

    .period-btn-desktop.active {
        background: #3b82f6;
        color: white;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Mobile Analytics Dashboard (visible only on mobile) -->
<div class="mobile-analytics-dashboard d-block d-md-none">
    <!-- Analytics Header -->
    <div class="analytics-header">
        <div class="analytics-header-content">
            <div class="analytics-info">
                <div class="analytics-avatar">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="analytics-details">
                    <h1 class="analytics-title">Аналитика</h1>
                    <p class="analytics-subtitle">Детальная статистика</p>
                </div>
            </div>
            <div class="analytics-welcome">
                <div class="analytics-welcome-text">Отчеты</div>
                <div class="analytics-welcome-subtext">и статистика</div>
                <a href="{{ url_for('admin_dashboard') }}" class="analytics-home-btn" style="margin-top: 0.5rem;">
                    <i class="fas fa-home"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Period Filter -->
    <div class="period-filter">
        <div id="periodInfoMobile" class="d-flex align-items-center">
            <i class="fas fa-info-circle"></i>
            Показаны данные за все время
        </div>
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-filter"></i> Фильтр
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <li><a class="dropdown-item period-btn" href="#" data-period="all" onclick="changePeriod('all')">Все время</a></li>
                <li><a class="dropdown-item period-btn" href="#" data-period="day" onclick="changePeriod('day')">День</a></li>
                <li><a class="dropdown-item period-btn" href="#" data-period="week" onclick="changePeriod('week')">Неделя</a></li>
                <li><a class="dropdown-item period-btn" href="#" data-period="month" onclick="changePeriod('month')">Месяц</a></li>
                <li><a class="dropdown-item period-btn" href="#" data-period="year" onclick="changePeriod('year')">Год</a></li>
            </ul>
        </div>
    </div>

    <!-- Overview Statistics -->
    <div class="overview-stats">
        <div class="overview-grid">
            <div class="overview-stat">
                <div class="overview-stat-icon users">
                    <i class="fas fa-users"></i>
                </div>
                <div class="overview-stat-number">{{ all_users|length }}</div>
                <div class="overview-stat-label">Студентов</div>
            </div>

            <div class="overview-stat">
                <div class="overview-stat-icon courses">
                    <i class="fas fa-book"></i>
                </div>
                <div class="overview-stat-number">{{ course_stats|length }}</div>
                <div class="overview-stat-label">Курсов</div>
            </div>

            <div class="overview-stat">
                <div class="overview-stat-icon certificates">
                    <i class="fas fa-certificate"></i>
                </div>
                <div class="overview-stat-number">{{ certificates|length }}</div>
                <div class="overview-stat-label">Сертификатов</div>
            </div>

            <div class="overview-stat">
                <div class="overview-stat-icon companies">
                    <i class="fas fa-building"></i>
                </div>
                <div class="overview-stat-number">{{ company_stats|length }}</div>
                <div class="overview-stat-label">Компаний</div>
            </div>
        </div>
    </div>

    <!-- Export Section -->
    <div class="export-section">
        <div class="export-card">
            <div class="export-header">
                <i class="fas fa-download"></i>
                <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">Экспорт отчетов</h3>
            </div>
            <div class="export-grid">
                <button class="export-btn excel" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i>
                    Excel
                </button>
                <button class="export-btn pdf" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i>
                    PDF
                </button>
                <button class="export-btn csv" onclick="exportToCSV()">
                    <i class="fas fa-file-csv"></i>
                    CSV
                </button>
                <button class="export-btn" onclick="exportFullReport()">
                    <i class="fas fa-chart-bar"></i>
                    Полный отчет
                </button>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <!-- Course Progress Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Прогресс по курсам
                </h3>
                <div class="chart-controls">
                    <button class="chart-btn" onclick="toggleChartType('courseProgress')">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="courseProgressChart"></canvas>
            </div>
        </div>

        <!-- Company Statistics Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-building"></i>
                    Статистика компаний
                </h3>
                <div class="chart-controls">
                    <button class="chart-btn" onclick="toggleChartType('companyStats')">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="companyStatsChart"></canvas>
            </div>
        </div>

        <!-- Certificate Trends Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-certificate"></i>
                    Выдача сертификатов по дням
                </h3>
                <div class="chart-controls">
                    <button class="chart-btn" onclick="toggleChartType('certificateTrends')">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="certificateTrendsChart"></canvas>
            </div>
        </div>

        <!-- User Activity Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-area"></i>
                    Активность пользователей
                </h3>
                <div class="chart-controls">
                    <button class="chart-btn" onclick="toggleChartType('userActivity')">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="userActivityChart"></canvas>
            </div>
        </div>

        <!-- Progress Distribution Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-bar"></i>
                    Распределение прогресса
                </h3>
                <div class="chart-controls">
                    <button class="chart-btn" onclick="toggleChartType('progressDistribution')">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="progressDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Course Analytics -->
    <div class="course-analytics-section">
        <div class="analytics-section-header">
            <h2 class="analytics-section-title">
                <i class="fas fa-chart-bar analytics-section-icon"></i>
                Статистика курсов
            </h2>
        </div>

        {% if course_stats %}
            {% for course_id, stats in course_stats.items() %}
            <div class="course-analytics-card">
                <div class="course-analytics-header">
                    <h3 class="course-analytics-title">{{ stats.course.title }}</h3>

                    <div class="course-metrics">
                        <div class="course-metric">
                            <div class="course-metric-number completed">{{ stats.completed_count }}</div>
                            <div class="course-metric-label">Завершили</div>
                        </div>
                        <div class="course-metric">
                            <div class="course-metric-number progress">{{ stats.in_progress_count }}</div>
                            <div class="course-metric-label">В процессе</div>
                        </div>
                        <div class="course-metric">
                            <div class="course-metric-number total">{{ stats.total_enrolled }}</div>
                            <div class="course-metric-label">Всего</div>
                        </div>
                    </div>
                </div>

                <div class="course-analytics-content">
                    <div class="course-completion-rate">
                        <span class="completion-rate-label">Средний прогресс:</span>
                        <span class="completion-rate-value">{{ "%.1f"|format(stats.average_progress) }}%</span>
                    </div>

                    <div class="course-progress-bar">
                        <div class="course-progress-fill"
                             style="width: {{ stats.average_progress }}%"></div>
                    </div>

                    {% if stats.users %}
                    <button class="students-toggle" onclick="toggleStudentsList('{{ course_id }}')">
                        <i class="fas fa-users"></i>
                        Студенты ({{ stats.users|length }})
                        <i class="fas fa-chevron-down"></i>
                    </button>

                    <div class="students-list" id="{{ course_id }}_students">
                        {% for user_data in stats.users %}
                        <div class="student-item">
                            <div class="student-avatar">
                                {{ user_data.user.name[0].upper() }}
                            </div>
                            <div class="student-info">
                                <div class="student-name">{{ user_data.user.name }}</div>
                                <div class="student-progress-bar">
                                    <div class="student-progress-fill"
                                         style="width: {{ user_data.progress_percent }}%; background: {% if user_data.completed %}#10b981{% else %}#3b82f6{% endif %}"></div>
                                </div>
                                <div class="student-progress-text">{{ "%.1f"|format(user_data.progress_percent) }}%</div>
                            </div>
                            <div class="student-status">
                                <div class="student-status-badge {% if user_data.completed %}completed{% else %}progress{% endif %}">
                                    <i class="fas {% if user_data.completed %}fa-check{% else %}fa-clock{% endif %}"></i>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h3>Нет данных по курсам</h3>
                <p>Статистика появится после создания курсов</p>
            </div>
        {% endif %}
    </div>

    <!-- Company Analytics -->
    <div class="company-analytics-section">
        <div class="analytics-section-header">
            <h2 class="analytics-section-title">
                <i class="fas fa-building analytics-section-icon"></i>
                Статистика компаний
            </h2>
        </div>

        <div class="company-analytics-grid">
            {% if company_stats %}
                {% for company, stats in company_stats.items() %}
                <div class="company-analytics-card">
                    <h3 class="company-name">
                        <div class="company-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        {{ company }}
                    </h3>

                    <div class="company-metrics">
                        <div class="company-metric">
                            <div class="company-metric-number employees">{{ stats.total_users }}</div>
                            <div class="company-metric-label">Сотрудников</div>
                        </div>
                        <div class="company-metric">
                            <div class="company-metric-number active">{{ stats.active_learners }}</div>
                            <div class="company-metric-label">Обучаются</div>
                        </div>
                        <div class="company-metric">
                            <div class="company-metric-number certificates">{{ stats.certificates_count }}</div>
                            <div class="company-metric-label">Сертификатов</div>
                        </div>
                    </div>

                    {% set activity_rate = (stats.active_learners / stats.total_users * 100) if stats.total_users > 0 else 0 %}
                    <div class="company-activity-bar">
                        <div class="activity-progress-fill" style="width: {{ activity_rate }}%"></div>
                    </div>

                    <div class="activity-rate">
                        <span class="activity-label">Активность:</span>
                        <span class="activity-percentage">{{ "%.0f"|format(activity_rate) }}%</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <h3>Нет данных по компаниям</h3>
                    <p>Статистика появится после регистрации пользователей</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Bottom Spacing -->
    <div class="bottom-spacing"></div>
</div>

<!-- Desktop Layout (hidden on mobile) -->
<div class="container-fluid d-none d-md-block">
    <div class="row">
        <!-- Enhanced Sidebar -->
        <div class="col-xl-3 col-lg-4 d-none d-lg-block">
            <div class="sidebar animate-fade-in">
                <div class="text-center mb-4">
                    <div class="d-inline-flex align-items-center justify-content-center bg-gradient-primary rounded-circle" style="width: 80px; height: 80px;">
                        <i class="fas fa-chart-bar text-white fa-2x"></i>
                    </div>
                    <h5 class="mt-3 mb-1">Аналитика</h5>
                    <small class="text-muted">Детальная статистика</small>
                </div>

                <div class="nav flex-column">
                    <a href="{{ url_for('admin_dashboard') }}" class="sidebar-item">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        <span>Главная</span>
                    </a>
                    <a href="{{ url_for('admin_courses') }}" class="sidebar-item">
                        <i class="fas fa-book me-2"></i>
                        <span>Курсы</span>
                    </a>
                    <a href="{{ url_for('admin_users') }}" class="sidebar-item">
                        <i class="fas fa-users me-2"></i>
                        <span>Пользователи</span>
                    </a>
                    <a href="{{ url_for('admin_analytics') }}" class="sidebar-item active">
                        <i class="fas fa-chart-bar me-2"></i>
                        <span>Аналитика</span>
                    </a>
                    <a href="{{ url_for('admin_phishing') }}" class="sidebar-item">
                        <i class="fas fa-shield-alt me-2"></i>
                        <span>Фишинг-проверки</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-xl-9 col-lg-8">
            <!-- Mobile Header -->
            <div class="d-lg-none mb-3">
                <div class="glass-card p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="bg-gradient-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <i class="fas fa-chart-bar text-white"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">Аналитика</h6>
                                <small class="text-muted">Детальная статистика</small>
                            </div>
                        </div>
                        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Header -->
            <div class="glass-card p-4 mb-4" style="background: var(--primary-gradient); color: white;">
                <h2 class="mb-2">
                    <i class="fas fa-chart-line me-2"></i>
                    Аналитика обучения
                </h2>
                <p class="mb-0 opacity-75">Детальная статистика по курсам и пользователям</p>
            </div>

            <!-- Period Filter -->
            <div class="period-filter-desktop">
                <div id="periodInfo" class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-1"></i>
                    Показаны данные за все время
                </div>
                <div>
                    <button class="period-btn-desktop active" data-period="all" onclick="changePeriod('all')">Все время</button>
                    <button class="period-btn-desktop" data-period="day" onclick="changePeriod('day')">День</button>
                    <button class="period-btn-desktop" data-period="week" onclick="changePeriod('week')">Неделя</button>
                    <button class="period-btn-desktop" data-period="month" onclick="changePeriod('month')">Месяц</button>
                    <button class="period-btn-desktop" data-period="year" onclick="changePeriod('year')">Год</button>
                </div>
            </div>

            <!-- Export Controls for Desktop -->
            <div class="glass-card p-4 mb-4">
                <h5 class="mb-3">
                    <i class="fas fa-download me-2"></i>
                    Экспорт отчетов
                </h5>
                <div class="export-controls-desktop">
                    <button class="export-btn-desktop excel" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i>
                        Экспорт в Excel
                    </button>
                    <button class="export-btn-desktop pdf" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i>
                        Экспорт в PDF
                    </button>
                    <button class="export-btn-desktop csv" onclick="exportToCSV()">
                        <i class="fas fa-file-csv"></i>
                        Экспорт в CSV
                    </button>
                    <button class="export-btn-desktop" onclick="exportFullReport()">
                        <i class="fas fa-chart-bar"></i>
                        Полный отчет
                    </button>
                </div>
            </div>

            <!-- Overall Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card primary text-center">
                        <div class="stat-number">{{ all_users|length }}</div>
                        <div>
                            <i class="fas fa-users mb-2" style="font-size: 1.5rem;"></i>
                            <div class="stat-label">Всего студентов</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card success text-center">
                        <div class="stat-number">{{ course_stats|length }}</div>
                        <div>
                            <i class="fas fa-book mb-2" style="font-size: 1.5rem;"></i>
                            <div class="stat-label">Курсов</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card warning text-center">
                        <div class="stat-number">{{ certificates|length }}</div>
                        <div>
                            <i class="fas fa-certificate mb-2" style="font-size: 1.5rem;"></i>
                            <div class="stat-label">Сертификатов выдано</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card secondary text-center">
                        <div class="stat-number">{{ company_stats|length }}</div>
                        <div>
                            <i class="fas fa-building mb-2" style="font-size: 1.5rem;"></i>
                            <div class="stat-label">Компаний</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <!-- Course Progress Chart -->
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>
                                Прогресс по курсам
                            </h5>
                            <div class="chart-controls-desktop">
                                <button class="chart-btn-desktop" onclick="toggleChartType('courseProgressDesktop')">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                        <div class="desktop-chart-container">
                            <canvas id="courseProgressChartDesktop"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Company Statistics Chart -->
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-building me-2"></i>
                                Статистика компаний
                            </h5>
                            <div class="chart-controls-desktop">
                                <button class="chart-btn-desktop" onclick="toggleChartType('companyStatsDesktop')">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                        <div class="desktop-chart-container">
                            <canvas id="companyStatsChartDesktop"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Certificate Trends Chart -->
            <div class="glass-card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-certificate me-2"></i>
                        Выдача сертификатов по дням
                    </h5>
                    <div class="chart-controls-desktop">
                        <button class="chart-btn-desktop" onclick="toggleChartType('certificateTrendsDesktop')">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
                <div class="desktop-chart-container">
                    <canvas id="certificateTrendsChartDesktop"></canvas>
                </div>
            </div>

            <!-- Advanced Analytics Grid -->
            <div class="row mb-4">
                <!-- User Activity Chart -->
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-area me-2"></i>
                                Активность пользователей
                            </h5>
                            <div class="chart-controls-desktop">
                                <button class="chart-btn-desktop" onclick="toggleChartType('userActivityDesktop')">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                        <div class="desktop-chart-container">
                            <canvas id="userActivityChartDesktop"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Progress Distribution Chart -->
                <div class="col-lg-6 mb-4">
                    <div class="glass-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>
                                Распределение прогресса
                            </h5>
                            <div class="chart-controls-desktop">
                                <button class="chart-btn-desktop" onclick="toggleChartType('progressDistributionDesktop')">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                        <div class="desktop-chart-container">
                            <canvas id="progressDistributionChartDesktop"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="glass-card p-4 mb-4">
                <h5 class="mb-4">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Метрики производительности
                </h5>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card-modern text-center p-3">
                            <div class="display-6 text-primary mb-2">{{ "%.1f"|format((certificates|length / all_users|length * 100) if all_users|length > 0 else 0) }}%</div>
                            <small class="text-muted">Коэффициент завершения</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card-modern text-center p-3">
                            <div class="display-6 text-success mb-2">{{ "%.1f"|format((course_stats.values()|sum(attribute='average_progress') / course_stats|length) if course_stats|length > 0 else 0) }}%</div>
                            <small class="text-muted">Средний прогресс</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card-modern text-center p-3">
                            <div class="display-6 text-warning mb-2">{{ company_stats|length }}</div>
                            <small class="text-muted">Активных компаний</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card-modern text-center p-3">
                            <div class="display-6 text-info mb-2">{{ "%.1f"|format((company_stats.values()|sum(attribute='active_learners') / company_stats.values()|sum(attribute='total_users') * 100) if company_stats.values()|sum(attribute='total_users') > 0 else 0) }}%</div>
                            <small class="text-muted">Общая активность</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Analytics -->
            <div class="glass-card p-4 mb-4">
                <h5 class="mb-4">
                    <i class="fas fa-chart-bar me-2"></i>
                    Статистика по курсам
                </h5>

                {% if course_stats %}
                    {% for course_id, stats in course_stats.items() %}
                    <div class="course-analytics mb-4">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="mb-3">{{ stats.course.title }}</h6>

                                <!-- Progress Statistics -->
                                <div class="row mb-3">
                                    <div class="col-4">
                                        <div class="text-center">
                                            <div class="fw-bold text-success fs-4">{{ stats.completed_count }}</div>
                                            <small class="text-muted">Завершили</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center">
                                            <div class="fw-bold text-primary fs-4">{{ stats.in_progress_count }}</div>
                                            <small class="text-muted">В процессе</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center">
                                            <div class="fw-bold text-info fs-4">{{ stats.total_enrolled }}</div>
                                            <small class="text-muted">Всего записано</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Average Progress -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">Средний прогресс:</span>
                                        <span class="fw-bold">{{ "%.1f"|format(stats.average_progress) }}%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-gradient"
                                             role="progressbar"
                                             style="width: {{ stats.average_progress }}%; background: var(--primary-gradient);">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="completion-chart text-center">
                                    {% set completion_rate = (stats.completed_count / stats.total_enrolled * 100) if stats.total_enrolled > 0 else 0 %}
                                    <div class="position-relative d-inline-block">
                                        <div class="circular-progress"
                                             data-percentage="{{ completion_rate }}"
                                             style="background: conic-gradient(var(--bs-success) {{ completion_rate * 3.6 }}deg, #e9ecef 0deg);">
                                        </div>
                                        <div class="position-absolute top-50 start-50 translate-middle">
                                            <div class="fw-bold">{{ "%.0f"|format(completion_rate) }}%</div>
                                            <small class="text-muted">завершений</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Student Details -->
                        {% if stats.users %}
                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#courseUsers{{ course_id }}">
                                <i class="fas fa-users me-1"></i>
                                Показать студентов ({{ stats.users|length }})
                            </button>

                            <div class="collapse mt-3" id="courseUsers{{ course_id }}">
                                <div class="row">
                                    {% for user_data in stats.users %}
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex align-items-center p-2 bg-white rounded">
                                            <div class="me-3">
                                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                    <i class="fas fa-user text-white"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="fw-medium">{{ user_data.user.name }}</div>
                                                <div class="progress mt-1" style="height: 4px;">
                                                    <div class="progress-bar bg-{{ 'success' if user_data.completed else 'primary' }}"
                                                         style="width: {{ user_data.progress_percent }}%"></div>
                                                </div>
                                                <small class="text-muted">{{ "%.1f"|format(user_data.progress_percent) }}%</small>
                                            </div>
                                            <div class="ms-2">
                                                {% if user_data.completed %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check"></i>
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-primary">
                                                        <i class="fas fa-clock"></i>
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3 opacity-50"></i>
                        <h6 class="text-muted">Нет данных для отображения</h6>
                    </div>
                {% endif %}
            </div>

            <!-- Company Analytics -->
            <div class="glass-card p-4">
                <h5 class="mb-4">
                    <i class="fas fa-building me-2"></i>
                    Статистика по компаниям
                </h5>

                {% if company_stats %}
                <div class="row">
                    {% for company, stats in company_stats.items() %}
                    <div class="col-lg-6 mb-4">
                        <div class="card-modern h-100">
                            <div class="card-body p-4">
                                <h6 class="mb-3">{{ company }}</h6>

                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="fw-bold text-primary fs-5">{{ stats.total_users }}</div>
                                        <small class="text-muted">Сотрудников</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-bold text-success fs-5">{{ stats.active_learners }}</div>
                                        <small class="text-muted">Обучаются</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-bold text-warning fs-5">{{ stats.certificates_count }}</div>
                                        <small class="text-muted">Сертификатов</small>
                                    </div>
                                </div>

                                {% set activity_rate = (stats.active_learners / stats.total_users * 100) if stats.total_users > 0 else 0 %}
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-muted">Активность:</span>
                                        <span class="fw-bold">{{ "%.0f"|format(activity_rate) }}%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-success"
                                             style="width: {{ activity_rate }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-building fa-3x text-muted mb-3 opacity-50"></i>
                        <h6 class="text-muted">Нет данных по компаниям</h6>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Global variables for charts
let courseProgressChart = null;
let companyStatsChart = null;
let certificateTrendsChart = null;
let userActivityChart = null;
let progressDistributionChart = null;
let courseProgressChartDesktop = null;
let companyStatsChartDesktop = null;
let certificateTrendsChartDesktop = null;
let userActivityChartDesktop = null;
let progressDistributionChartDesktop = null;

// Chart types state
let chartTypes = {
    courseProgress: 'pie',
    companyStats: 'doughnut',
    certificateTrends: 'line',
    userActivity: 'bar',
    progressDistribution: 'bar',
    courseProgressDesktop: 'pie',
    companyStatsDesktop: 'bar',
    certificateTrendsDesktop: 'line',
    userActivityDesktop: 'line',
    progressDistributionDesktop: 'doughnut'
};

// Data for charts
const analyticsData = {
    courseStats: {{ course_stats | tojson | safe }},
    companyStats: {{ company_stats | tojson | safe }},
    certificates: {{ certificates | tojson | safe }},
    allUsers: {{ all_users | tojson | safe }},
    userActivity: {{ user_activity_data | tojson | safe }}
};

// Store original data for filtering
const originalData = {
    courseStats: null,
    companyStats: null,
    certificates: null,
    allUsers: null,
    userActivity: null
};

let currentPeriod = 'all'; // Default period

// Period filtering functions
function changePeriod(period) {
    currentPeriod = period;

    // Update active button states
    document.querySelectorAll('.period-btn, .period-btn-desktop').forEach(btn => {
        btn.classList.remove('active');
    });

    document.querySelectorAll(`[data-period="${period}"]`).forEach(btn => {
        btn.classList.add('active');
    });

    // Update period info text
    const periodTexts = {
        'all': 'Показаны данные за все время',
        'day': 'Показаны данные за последний день',
        'week': 'Показаны данные за последнюю неделю',
        'month': 'Показаны данные за последний месяц',
        'year': 'Показаны данные за последний год'
    };

    const periodInfo = document.getElementById('periodInfo');
    const periodInfoMobile = document.getElementById('periodInfoMobile');

    if (periodInfo) {
        periodInfo.innerHTML = `<i class="fas fa-info-circle me-1"></i>${periodTexts[period]}`;
    }
    if (periodInfoMobile) {
        periodInfoMobile.innerHTML = `<i class="fas fa-info-circle"></i> ${periodTexts[period]}`;
    }

    // Filter data and update charts
    filterDataByPeriod(period);
    updateChartsWithFilteredData();
    updateStatsWithFilteredData();
}

function filterDataByPeriod(period) {
    // Store original data on first filter
    if (!originalData.certificates) {
        originalData.courseStats = JSON.parse(JSON.stringify(analyticsData.courseStats));
        originalData.companyStats = JSON.parse(JSON.stringify(analyticsData.companyStats));
        originalData.certificates = JSON.parse(JSON.stringify(analyticsData.certificates));
        originalData.allUsers = JSON.parse(JSON.stringify(analyticsData.allUsers));
        originalData.userActivity = JSON.parse(JSON.stringify(analyticsData.userActivity));
    }

    if (period === 'all') {
        // Reset to original data
        analyticsData.courseStats = JSON.parse(JSON.stringify(originalData.courseStats));
        analyticsData.companyStats = JSON.parse(JSON.stringify(originalData.companyStats));
        analyticsData.certificates = JSON.parse(JSON.stringify(originalData.certificates));
        analyticsData.allUsers = JSON.parse(JSON.stringify(originalData.allUsers));
        analyticsData.userActivity = JSON.parse(JSON.stringify(originalData.userActivity));
        return;
    }

    // Calculate date range
    const now = new Date();
    let startDate = new Date();

    switch (period) {
        case 'day':
            startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            break;
        case 'week':
            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
        case 'month':
            startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            break;
        case 'year':
            startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
            break;
    }

    // Filter certificates by date
    analyticsData.certificates = originalData.certificates.filter(cert => {
        if (!cert.issued_at) return false;
        const certDate = new Date(cert.issued_at);
        return certDate >= startDate;
    });

    // Filter user activity by date
    analyticsData.userActivity = originalData.userActivity.filter(activity => {
        if (!activity.date) return false;
        const activityDate = new Date(activity.date);
        return activityDate >= startDate;
    });

    // Filter users by registration date
    analyticsData.allUsers = originalData.allUsers.filter(user => {
        if (!user.registered_at) return true; // Keep users without registration date
        const regDate = new Date(user.registered_at);
        return regDate >= startDate;
    });

    // Note: Course and company stats are kept as-is since they represent current state
    // rather than time-based events. If time-based course/company stats were needed,
    // they would require a different data structure and filtering logic.
}

function updateChartsWithFilteredData() {
    // Reinitialize all charts with filtered data
    initializeCharts();
}

function updateStatsWithFilteredData() {
    // Update overview stats cards
    const userCount = analyticsData.allUsers.length;
    const certificateCount = analyticsData.certificates.length;

    // Update desktop stats
    const statCards = document.querySelectorAll('.stat-number');
    if (statCards.length >= 4) {
        statCards[0].textContent = userCount; // Users
        statCards[2].textContent = certificateCount; // Certificates
    }

    // Update mobile stats
    const overviewStats = document.querySelectorAll('.overview-stat-number');
    if (overviewStats.length >= 4) {
        overviewStats[0].textContent = userCount; // Users
        overviewStats[2].textContent = certificateCount; // Certificates
    }
}


// Mobile Analytics Interactions
function toggleStudentsList(courseId) {
    const studentsListId = courseId + '_students';
    const studentsList = document.getElementById(studentsListId);
    const button = document.querySelector(`[onclick="toggleStudentsList('${courseId}')"] i:last-child`);

    if (studentsList) {
        studentsList.classList.toggle('active');

        if (studentsList.classList.contains('active')) {
            button.className = 'fas fa-chevron-up';
        } else {
            button.className = 'fas fa-chevron-down';
        }
    }
}

// Chart initialization
function initializeCharts() {
    console.log('Initializing charts with data:', {
        certificates: analyticsData.certificates?.length || 0,
        courseStats: Object.keys(analyticsData.courseStats || {}).length,
        companyStats: Object.keys(analyticsData.companyStats || {}).length
    });

    // Mobile charts
    if (window.innerWidth <= 768) {
        initCourseProgressChart('courseProgressChart', 'mobile');
        initCompanyStatsChart('companyStatsChart', 'mobile');
        initCertificateTrendsChart('certificateTrendsChart', 'mobile');
        initUserActivityChart('userActivityChart', 'mobile');
        initProgressDistributionChart('progressDistributionChart', 'mobile');
    }

    // Desktop charts
    if (window.innerWidth > 768) {
        initCourseProgressChart('courseProgressChartDesktop', 'desktop');
        initCompanyStatsChart('companyStatsChartDesktop', 'desktop');
        initCertificateTrendsChart('certificateTrendsChartDesktop', 'desktop');
        initUserActivityChart('userActivityChartDesktop', 'desktop');
        initProgressDistributionChart('progressDistributionChartDesktop', 'desktop');
    }
}

function initCourseProgressChart(canvasId, platform) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    const courseData = Object.values(analyticsData.courseStats);
    const labels = courseData.map(course => course.course?.title || 'Неизвестный курс');
    const completed = courseData.map(course => course.completed_count || 0);
    const inProgress = courseData.map(course => course.in_progress_count || 0);
    const total = courseData.map(course => course.total_enrolled || 0);

    const chartType = platform === 'mobile' ? chartTypes.courseProgress : chartTypes.courseProgressDesktop;

    const config = {
        type: chartType,
        data: {
            labels: labels,
            datasets: chartType === 'pie' || chartType === 'doughnut' ? [{
                label: 'Завершившие', // Added for tooltips even in pie/doughnut
                data: completed,
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                    '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }] : [
                {
                    label: 'Завершили',
                    data: completed,
                    backgroundColor: '#10b981',
                    borderColor: '#059669',
                    borderWidth: 2
                },
                {
                    label: 'В процессе',
                    data: inProgress,
                    backgroundColor: '#3b82f6',
                    borderColor: '#2563eb',
                    borderWidth: 2
                },
                {
                    label: 'Всего записано',
                    data: total,
                    backgroundColor: '#6b7280',
                    borderColor: '#4b5563',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: platform === 'mobile' ? 'bottom' : 'right',
                    labels: {
                        padding: 15,
                        font: {
                            size: platform === 'mobile' ? 10 : 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (chartType === 'pie' || chartType === 'doughnut') {
                                const totalDatasetValue = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / totalDatasetValue) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                            return `${context.dataset.label}: ${context.parsed}`;
                        }
                    }
                }
            },
            scales: chartType === 'bar' ? {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            } : {}
        }
    };

    if (platform === 'mobile') {
        if (courseProgressChart) courseProgressChart.destroy();
        courseProgressChart = new Chart(ctx, config);
    } else {
        if (courseProgressChartDesktop) courseProgressChartDesktop.destroy();
        courseProgressChartDesktop = new Chart(ctx, config);
    }
}

function initCompanyStatsChart(canvasId, platform) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    const companies = Object.keys(analyticsData.companyStats);
    const totalUsers = companies.map(company => analyticsData.companyStats[company]?.total_users || 0);
    const activeUsers = companies.map(company => analyticsData.companyStats[company]?.active_learners || 0);
    const certificates = companies.map(company => analyticsData.companyStats[company]?.certificates_count || 0);

    const chartType = platform === 'mobile' ? chartTypes.companyStats : chartTypes.companyStatsDesktop;

    const config = {
        type: chartType,
        data: {
            labels: companies,
            datasets: chartType === 'doughnut' ? [{
                label: 'Активные обучающиеся', // Added for tooltips
                data: activeUsers, // Display active users for doughnut
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                    '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }] : [
                {
                    label: 'Всего сотрудников',
                    data: totalUsers,
                    backgroundColor: '#3b82f6',
                    borderColor: '#2563eb',
                    borderWidth: 2
                },
                {
                    label: 'Активные обучающиеся',
                    data: activeUsers,
                    backgroundColor: '#10b981',
                    borderColor: '#059669',
                    borderWidth: 2
                },
                {
                    label: 'Сертификаты',
                    data: certificates,
                    backgroundColor: '#f59e0b',
                    borderColor: '#d97706',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: platform === 'mobile' ? 'bottom' : 'top',
                    labels: {
                        padding: 15,
                        font: {
                            size: platform === 'mobile' ? 10 : 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (chartType === 'doughnut') {
                                const totalDatasetValue = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / totalDatasetValue) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                            return `${context.dataset.label}: ${context.parsed}`;
                        }
                    }
                }
            },
            scales: chartType === 'bar' ? {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            } : {}
        }
    };

    if (platform === 'mobile') {
        if (companyStatsChart) companyStatsChart.destroy();
        companyStatsChart = new Chart(ctx, config);
    } else {
        if (companyStatsChartDesktop) companyStatsChartDesktop.destroy();
        companyStatsChartDesktop = new Chart(ctx, config);
    }
}

function initCertificateTrendsChart(canvasId, platform) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    // Group certificates by day, considering the current period filter
    const dailyData = {};
    const filteredCertificates = analyticsData.certificates || []; // Use already filtered data

    console.log('Certificate data for trends:', filteredCertificates);

    if (filteredCertificates.length === 0) {
        // If no certificates, create dummy data to show empty chart for last 7 days
        const now = new Date();
        for (let i = 6; i >= 0; i--) {
            const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            dailyData[dateKey] = 0;
        }
    } else {
        filteredCertificates.forEach(cert => {
            if (cert.issued_at) {
                const date = new Date(cert.issued_at);
                // Format to YYYY-MM-DD for grouping by day
                const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                dailyData[dateKey] = (dailyData[dateKey] || 0) + 1;
            }
        });
    }

    const sortedDays = Object.keys(dailyData).sort();
    const labels = sortedDays.map(day => {
        const [year, month, dayNum] = day.split('-');
        const date = new Date(year, month - 1, dayNum);
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
    });
    const data = sortedDays.map(day => dailyData[day]);

    console.log('Certificate trends - Labels:', labels);
    console.log('Certificate trends - Data:', data);

    const chartType = platform === 'mobile' ? chartTypes.certificateTrends : chartTypes.certificateTrendsDesktop;

    const config = {
        type: chartType,
        data: {
            labels: labels,
            datasets: [{
                label: 'Выданные сертификаты',
                data: data,
                borderColor: '#10b981',
                backgroundColor: chartType === 'line' ? 'rgba(16, 185, 129, 0.1)' : '#10b981',
                borderWidth: 3,
                fill: chartType === 'line',
                tension: 0.4,
                pointBackgroundColor: '#10b981',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: {
                            size: platform === 'mobile' ? 10 : 12
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            if (context.parsed.y === 0) {
                                return 'В этот день сертификаты не выданы';
                            } else if (context.parsed.y === 1) {
                                return 'Выдан 1 сертификат';
                            } else if (context.parsed.y < 5) {
                                return `Выдано ${context.parsed.y} сертификата`;
                            } else {
                                return `Выдано ${context.parsed.y} сертификатов`;
                            }
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxTicksLimit: platform === 'mobile' ? 7 : 14 // Ограничиваем количество меток на оси X
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return value >= 0 ? value : '';
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            // Add empty state message
            animation: {
                onComplete: function() {
                    if (data.every(val => val === 0)) {
                        const chart = this;
                        const ctx = chart.ctx;
                        const width = chart.width;
                        const height = chart.height;
                        
                        ctx.save();
                        ctx.font = platform === 'mobile' ? '14px Arial' : '16px Arial';
                        ctx.fillStyle = '#6b7280';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('За выбранный период сертификаты не выданы', width / 2, height / 2);
                        ctx.restore();
                    }
                }
            }
        }
    };

    if (platform === 'mobile') {
        if (certificateTrendsChart) certificateTrendsChart.destroy();
        certificateTrendsChart = new Chart(ctx, config);
    } else {
        if (certificateTrendsChartDesktop) certificateTrendsChartDesktop.destroy();
        certificateTrendsChartDesktop = new Chart(ctx, config);
    }
}

function initUserActivityChart(canvasId, platform) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    const activityLabels = [];
    const activityCounts = [];

    // Use filtered user activity data
    const recentActivity = analyticsData.userActivity;

    // Determine the number of days to show based on currentPeriod and platform
    let daysToShow;
    if (platform === 'mobile') {
        daysToShow = (currentPeriod === 'week' || currentPeriod === 'day') ? recentActivity.length : 7;
    } else { // Desktop
        daysToShow = (currentPeriod === 'month' || currentPeriod === 'week' || currentPeriod === 'day') ? recentActivity.length : 30;
    }
    
    // Ensure we don't try to show more days than available in the filtered data
    const limitedActivity = recentActivity.slice(-daysToShow);

    limitedActivity.forEach(day => {
        // Dynamically format labels based on platform and current period for better readability
        let formattedLabel;
        const dateObj = new Date(day.date); // Assuming 'date' field exists in userActivity data
        
        if (platform === 'mobile') {
            formattedLabel = day.day_name ? `${day.day_name} ${day.day_number}` : `${day.day_number}.${dateObj.getMonth() + 1}`;
        } else { // Desktop
            formattedLabel = `${day.day_number}.${dateObj.getMonth() + 1}`;
        }
        activityLabels.push(formattedLabel);
        activityCounts.push(day.active_users);
    });

    const chartType = platform === 'mobile' ? chartTypes.userActivity : chartTypes.userActivityDesktop;

    const config = {
        type: chartType,
        data: {
            labels: activityLabels,
            datasets: [{
                label: 'Активные пользователи',
                data: activityCounts,
                backgroundColor: chartType === 'line' ? 'rgba(59, 130, 246, 0.1)' : '#3b82f6',
                borderColor: '#2563eb',
                borderWidth: 3,
                fill: chartType === 'line',
                tension: 0.4,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: {
                            size: platform === 'mobile' ? 10 : 12
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 5
                    }
                }
            }
        }
    };

    if (platform === 'mobile') {
        if (userActivityChart) userActivityChart.destroy();
        userActivityChart = new Chart(ctx, config);
    } else {
        if (userActivityChartDesktop) userActivityChartDesktop.destroy();
        userActivityChartDesktop = new Chart(ctx, config);
    }
}

function initProgressDistributionChart(canvasId, platform) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    const ranges = ['0-25%', '26-50%', '51-75%', '76-99%', '100%'];
    const distributionData = [0, 0, 0, 0, 0]; // Initialize counters

    // Count users in each progress range based on their actual course progress
    // Use filtered course stats data
    Object.values(analyticsData.courseStats).forEach(courseData => {
        courseData.users.forEach(userData => {
            const progress = userData.progress_percent;
            if (progress >= 0 && progress <= 25) {
                distributionData[0]++;
            } else if (progress > 25 && progress <= 50) {
                distributionData[1]++;
            } else if (progress > 50 && progress <= 75) {
                distributionData[2]++;
            } else if (progress > 75 && progress < 100) {
                distributionData[3]++;
            } else if (progress >= 100) {
                distributionData[4]++;
            }
        });
    });

    const chartType = platform === 'mobile' ? chartTypes.progressDistribution : chartTypes.progressDistributionDesktop;

    const config = {
        type: chartType,
        data: {
            labels: ranges,
            datasets: [{
                data: distributionData,
                backgroundColor: [
                    '#ef4444', // 0-25% - красный
                    '#f59e0b', // 26-50% - оранжевый
                    '#3b82f6', // 51-75% - синий
                    '#10b981', // 76-99% - зеленый
                    '#059669'  // 100% - темно-зеленый
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: platform === 'mobile' ? 'bottom' : 'right',
                    labels: {
                        padding: 15,
                        font: {
                            size: platform === 'mobile' ? 10 : 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const totalDatasetValue = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / totalDatasetValue) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            },
            scales: chartType === 'bar' ? {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            } : {}
        }
    };

    if (platform === 'mobile') {
        if (progressDistributionChart) progressDistributionChart.destroy();
        progressDistributionChart = new Chart(ctx, config);
    } else {
        if (progressDistributionChartDesktop) progressDistributionChartDesktop.destroy();
        progressDistributionChartDesktop = new Chart(ctx, config);
    }
}

// Toggle chart types
function toggleChartType(chartName) {
    const isMobile = window.innerWidth <= 768;
    const platform = isMobile ? 'mobile' : 'desktop';

    if (chartName.includes('courseProgress')) {
        const currentType = isMobile ? chartTypes.courseProgress : chartTypes.courseProgressDesktop;
        const newType = currentType === 'pie' ? 'bar' : 'pie';

        if (isMobile) {
            chartTypes.courseProgress = newType;
            initCourseProgressChart('courseProgressChart', 'mobile');
        } else {
            chartTypes.courseProgressDesktop = newType;
            initCourseProgressChart('courseProgressChartDesktop', 'desktop');
        }
    } else if (chartName.includes('companyStats')) {
        const currentType = isMobile ? chartTypes.companyStats : chartTypes.companyStatsDesktop;
        const newType = currentType === 'doughnut' ? 'bar' : 'doughnut';

        if (isMobile) {
            chartTypes.companyStats = newType;
            initCompanyStatsChart('companyStatsChart', 'mobile');
        } else {
            chartTypes.companyStatsDesktop = newType;
            initCompanyStatsChart('companyStatsChartDesktop', 'desktop');
        }
    } else if (chartName.includes('certificateTrends')) {
        const currentType = isMobile ? chartTypes.certificateTrends : chartTypes.certificateTrendsDesktop;
        const newType = currentType === 'line' ? 'bar' : 'line';

        if (isMobile) {
            chartTypes.certificateTrends = newType;
            initCertificateTrendsChart('certificateTrendsChart', 'mobile');
        } else {
            chartTypes.certificateTrendsDesktop = newType;
            initCertificateTrendsChart('certificateTrendsChartDesktop', 'desktop');
        }
    } else if (chartName.includes('userActivity')) {
        const currentType = isMobile ? chartTypes.userActivity : chartTypes.userActivityDesktop;
        const newType = currentType === 'bar' ? 'line' : 'bar';

        if (isMobile) {
            chartTypes.userActivity = newType;
            initUserActivityChart('userActivityChart', 'mobile');
        } else {
            chartTypes.userActivityDesktop = newType;
            initUserActivityChart('userActivityChartDesktop', 'desktop');
        }
    } else if (chartName.includes('progressDistribution')) {
        const currentType = isMobile ? chartTypes.progressDistribution : chartTypes.progressDistributionDesktop;
        const newType = currentType === 'bar' ? 'doughnut' : 'bar';

        if (isMobile) {
            chartTypes.progressDistribution = newType;
            initProgressDistributionChart('progressDistributionChart', 'mobile');
        } else {
            chartTypes.progressDistributionDesktop = newType;
            initProgressDistributionChart('progressDistributionChartDesktop', 'desktop');
        }
    }
}

// Export functions
function exportToExcel() {
    fetch('/admin/analytics/export/excel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(analyticsData) // Use current analyticsData which might be filtered
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `analytics_report_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showNotification('Отчет Excel успешно скачан', 'success');
    })
    .catch(error => {
        console.error('Error exporting to Excel:', error);
        showNotification('Ошибка при экспорте в Excel', 'error');
    });
}

function exportToPDF() {
    fetch('/admin/analytics/export/pdf', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(analyticsData) // Use current analyticsData which might be filtered
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `analytics_report_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showNotification('Отчет PDF успешно скачан', 'success');
    })
    .catch(error => {
        console.error('Error exporting to PDF:', error);
        showNotification('Ошибка при экспорте в PDF', 'error');
    });
}

function exportToCSV() {
    fetch('/admin/analytics/export/csv', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(analyticsData) // Use current analyticsData which might be filtered
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `analytics_report_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showNotification('Отчет CSV успешно скачан', 'success');
    })
    .catch(error => {
        console.error('Error exporting to CSV:', error);
        showNotification('Ошибка при экспорте в CSV', 'error');
    });
}

function exportFullReport() {
    fetch('/admin/analytics/export/full', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(analyticsData) // Use current analyticsData which might be filtered
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `full_analytics_report_${new Date().toISOString().split('T')[0]}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showNotification('Полный отчет успешно скачан', 'success');
    })
    .catch(error => {
        console.error('Error exporting full report:', error);
        showNotification('Ошибка при экспорте полного отчета', 'error');
    });
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// Enhanced mobile interactions
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts with initial data
    initializeCharts();

    // Add smooth transitions for progress bars
    const progressBars = document.querySelectorAll('.course-progress-fill, .student-progress-fill, .activity-progress-fill');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';

        setTimeout(() => {
            bar.style.width = width;
        }, 100);
    });

    // Add touch feedback for interactive elements
    const touchElements = document.querySelectorAll('.students-toggle, .overview-stat, .course-analytics-card, .company-analytics-card, .export-btn, .chart-btn, .period-btn');
    touchElements.forEach(element => {
        element.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.98)';
        });

        element.addEventListener('touchend', function() {
            this.style.transform = 'scale(1)';
        });
    });

    // Responsive chart handling
    window.addEventListener('resize', function() {
        // Debounce or throttle resize handler if performance is an issue
        setTimeout(() => {
            initializeCharts();
        }, 250);
    });
});
</script>

{% endblock %}