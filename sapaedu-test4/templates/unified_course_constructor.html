<!doctype html>
<html>
    <head>
        <title>Конструктор курсов - Sapa Edu</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />
        <style>
            body {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            .main-container {
                background: white;
                border-radius: 20px;
                margin: 20px;
                padding: 30px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                min-height: calc(100vh - 40px);
            }

            .header {
                text-align: center;
                margin-bottom: 40px;
                padding-bottom: 20px;
                border-bottom: 2px solid #e9ecef;
            }

            .header h1 {
                color: #2c3e50;
                font-weight: 700;
                margin-bottom: 10px;
            }

            .header p {
                color: #7f8c8d;
                font-size: 1.1rem;
            }

            .section-card {
                background: #f8f9fa;
                border-radius: 15px;
                padding: 20px;
                margin: 20px 0;
                border-left: 5px solid #007bff;
                transition: all 0.3s ease;
            }

            .section-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

            .section-title {
                color: #2c3e50;
                font-weight: 600;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .form-control, .form-select {
                border-radius: 10px;
                border: 2px solid #e9ecef;
                padding: 12px 15px;
                font-size: 16px;
                transition: border-color 0.3s ease;
            }

            .form-control:focus, .form-select:focus {
                border-color: #007bff;
                box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
            }

            .btn {
                border-radius: 10px;
                padding: 12px 24px;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }

            .chapter-item {
                background: white;
                border-radius: 12px;
                padding: 20px;
                margin: 15px 0;
                border: 2px solid #e9ecef;
                box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            }

            .content-block {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 15px;
                margin: 10px 0;
                border-left: 3px solid #28a745;
            }

            .question-item {
                background: white;
                border-radius: 10px;
                padding: 15px;
                margin: 10px 0;
                border: 1px solid #dee2e6;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }

            .answer-option {
                display: flex;
                align-items: center;
                gap: 10px;
                margin: 8px 0;
                padding: 8px;
                background: #f8f9fa;
                border-radius: 5px;
            }

            .progress-bar-custom {
                height: 6px;
                border-radius: 3px;
                background: linear-gradient(90deg, #007bff 0%, #28a745 100%);
                margin: 20px 0;
            }

            .floating-save {
                position: fixed;
                bottom: 30px;
                right: 30px;
                z-index: 1000;
            }

            @media (max-width: 768px) {
                .main-container {
                    margin: 10px;
                    padding: 20px;
                    border-radius: 15px;
                }

                .floating-save {
                    bottom: 20px;
                    right: 20px;
                }
            }

            .image-preview {
                max-width: 100%;
                border-radius: 8px;
                margin-top: 10px;
            }

            .image-preview img {
                max-width: 300px;
                max-height: 200px;
                border-radius: 8px;
            }

            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                max-width: 400px;
                border-radius: 10px;
                padding: 15px 20px;
                font-weight: 600;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                transform: translateX(500px);
                transition: transform 0.3s ease;
            }

            .notification.show {
                transform: translateX(0);
            }

            .notification.success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .notification.error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .notification.info {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }
        </style>
    </head>
    <body>
        <div class="main-container">
            <div class="header">
                <h1><i class="fas fa-magic me-3"></i>Конструктор курсов</h1>
                <p>Создайте новый курс быстро и просто</p>
                <div class="progress-bar-custom" style="width: 0%" id="progressBar"></div>
            </div>

            <!-- Course Selection for Edit -->
            <div class="section-card" id="courseSelectionSection">
                <div class="section-title">
                    <i class="fas fa-edit text-warning"></i>
                    <span>Редактирование курса</span>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label class="form-label">Выберите курс для редактирования (необязательно)</label>
                            <select class="form-select" id="courseToEdit" onchange="loadCourseForEdit()">
                                <option value="">-- Создать новый курс --</option>
                                {% if courses %}
                                    {% for course in courses %}
                                    <option value="{{ course.id }}" {% if selected_course and selected_course.id == course.id %}selected{% endif %}>
                                        {{ course.title }} {% if not course.is_published %}(Черновик){% endif %}
                                    </option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                            <small class="form-text text-muted">Выберите существующий курс для редактирования или оставьте пустым для создания нового</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Info Section -->
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-info-circle text-primary"></i>
                    <span>Основная информация</span>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Название курса *</label>
                            <input type="text" class="form-control" id="courseTitle" placeholder="Введите название курса" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Тип курса</label>
                            <select class="form-select" id="courseType">
                                <option value="revocable">Отзывной сертификат</option>
                                <option value="static">Статичный сертификат</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" rows="3" id="courseDescription" placeholder="Краткое описание курса"></textarea>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Введение</label>
                            <textarea class="form-control" rows="4" id="courseIntroduction" placeholder="Что изучит студент"></textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Заключение</label>
                            <textarea class="form-control" rows="4" id="courseConclusion" placeholder="Заключительная часть"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chapters Section -->
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-book text-success"></i>
                    <span>Главы курса</span>
                    <div class="ms-auto">
                        <button class="btn btn-success btn-sm" onclick="addChapter()">
                            <i class="fas fa-plus"></i> Добавить главу
                        </button>
                    </div>
                </div>
                <div id="chaptersContainer">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-book fa-3x mb-3"></i>
                        <p>Нажмите "Добавить главу" чтобы создать первую главу курса</p>
                    </div>
                </div>
            </div>

            <!-- Exam Section -->
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-clipboard-check text-danger"></i>
                    <span>Итоговый экзамен</span>
                    <div class="ms-auto">
                        <button class="btn btn-primary btn-sm" onclick="toggleExam()" id="examToggle">
                            <i class="fas fa-plus"></i> Добавить экзамен
                        </button>
                    </div>
                </div>
                <div id="examContainer" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Проходной балл (%)</label>
                            <input type="number" class="form-control" min="50" max="100" value="80" id="examPassingScore">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Время (минут)</label>
                            <input type="number" class="form-control" min="5" max="60" value="15" id="examTimeLimit">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Максимум попыток</label>
                            <input type="number" class="form-control" min="1" max="5" value="2" id="examMaxAttempts">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Вопросы экзамена</h6>
                        <button class="btn btn-outline-primary btn-sm" onclick="addExamQuestion()">
                            <i class="fas fa-plus"></i> Добавить вопрос
                        </button>
                    </div>
                    <div id="examQuestions">
                        <div class="text-center text-muted py-3">
                            <p>Добавьте вопросы для экзамена</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Certificate Settings Section -->
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-certificate text-purple"></i>
                    <span>Настройки сертификата</span>
                </div>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="certificate-settings-tab" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-certificate me-2"></i>Настройки сертификата</h5>
                            </div>
                            <div class="card-body">
                                <!-- Basic Settings -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Заголовок сертификата</label>
                                            <input type="text" class="form-control" id="certificate-title" 
                                                   placeholder="СЕРТИФИКАТ" value="СЕРТИФИКАТ">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Подзаголовок</label>
                                            <input type="text" class="form-control" id="certificate-subtitle" 
                                                   placeholder="о прохождении курса" value="о прохождении курса">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Организация</label>
                                            <input type="text" class="form-control" id="certificate-organization" 
                                                   placeholder="SapaEdu" value="SapaEdu">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">URL логотипа</label>
                                            <input type="url" class="form-control" id="certificate-logo-url" 
                                                   placeholder="https://example.com/logo.png">
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <!-- Design Settings -->
                                <h6 class="mb-3"><i class="fas fa-palette me-2"></i>Дизайн и цвета</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Фоновый цвет</label>
                                            <input type="color" class="form-control form-control-color" 
                                                   id="certificate-bg-color" value="#ffffff">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Основной цвет</label>
                                            <input type="color" class="form-control form-control-color" 
                                                   id="certificate-primary-color" value="#007bff">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Вторичный цвет</label>
                                            <input type="color" class="form-control form-control-color" 
                                                   id="certificate-secondary-color" value="#6c757d">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Акцентный цвет</label>
                                            <input type="color" class="form-control form-control-color" 
                                                   id="certificate-accent-color" value="#28a745">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Стиль рамки</label>
                                            <select class="form-select" id="certificate-border-style">
                                                <option value="modern">Современный</option>
                                                <option value="classic">Классический</option>
                                                <option value="elegant">Элегантный</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Стиль макета</label>
                                            <select class="form-select" id="certificate-layout-style">
                                                <option value="standard">Стандартный</option>
                                                <option value="minimal">Минимальный</option>
                                                <option value="decorative">Декоративный</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Значок достижения</label>
                                            <select class="form-select" id="certificate-achievement-badge">
                                                <option value="graduation">Выпуск</option>
                                                <option value="shield">Щит</option>
                                                <option value="star">Звезда</option>
                                                <option value="trophy">Трофей</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <!-- Watermark Settings -->
                                <h6 class="mb-3"><i class="fas fa-layer-group me-2"></i>Водяной знак</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Текст водяного знака</label>
                                            <input type="text" class="form-control" id="certificate-watermark-text" 
                                                   placeholder="SapaEdu" value="SapaEdu">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Прозрачность (%)</label>
                                            <input type="range" class="form-range" id="certificate-watermark-opacity" 
                                                   min="0" max="50" value="10">
                                            <small class="text-muted">Текущее: <span id="opacity-value">10</span>%</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Показать QR-код</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="certificate-show-qr" checked>
                                                <label class="form-check-label" for="certificate-show-qr">
                                                    Включить QR-код
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <!-- Achievement Settings -->
                                <h6 class="mb-3"><i class="fas fa-trophy me-2"></i>Настройки достижения</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Текст достижения</label>
                                            <input type="text" class="form-control" id="certificate-achievement-text" 
                                                   placeholder="Успешно завершен курс" value="Успешно завершен курс">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Текст действительности</label>
                                            <input type="text" class="form-control" id="certificate-validity-text" 
                                                   placeholder="Действителен на момент выдачи" value="Действителен на момент выдачи">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Дополнительный текст в подвале</label>
                                    <textarea class="form-control" id="certificate-footer-text" rows="2" 
                                              placeholder="Дополнительная информация для отображения в нижней части сертификата"></textarea>
                                </div>

                                <hr class="my-4">

                                <!-- Background Settings -->
                                <h6 class="mb-3"><i class="fas fa-image me-2"></i>Настройки фона</h6>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label class="form-label">URL фонового изображения</label>
                                            <input type="url" class="form-control" id="certificate-background-url" 
                                                   placeholder="https://example.com/background.jpg">
                                            <small class="form-text text-muted">Рекомендуемый размер: 1200x850px</small>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <!-- Author Section -->
                                <h6 class="mb-3"><i class="fas fa-user-edit me-2"></i>Автор курса</h6>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">ФИО автора курса</label>
                                            <input type="text" class="form-control" id="certificate-author-name" 
                                                   placeholder="Иванов Иван Иванович">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Должность автора</label>
                                            <input type="text" class="form-control" id="certificate-author-position" 
                                                   placeholder="Старший специалист по безопасности">
                                        </div>
                                    </div>
                                </div>

                                <!-- Preview Button -->
                                <div class="text-center mt-4">
                                    <button type="button" class="btn btn-outline-primary" onclick="previewCertificate()">
                                        <i class="fas fa-eye me-2"></i>Предварительный просмотр
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="text-center mt-4">
                <button class="btn btn-outline-secondary me-3" onclick="previewCourse()">
                    <i class="fas fa-eye"></i> Предпросмотр
                </button>
                <button class="btn btn-info me-3" onclick="saveDraft()">
                    <i class="fas fa-save"></i> Сохранить черновик
                </button>
                <button class="btn btn-success" onclick="publishCourse()">
                    <i class="fas fa-check"></i> Опубликовать курс
                </button>
            </div>
        </div>

        <!-- Floating Save Button -->
        <button class="btn btn-primary btn-lg rounded-circle floating-save" onclick="saveDraft()" title="Быстрое сохранение">
            <i class="fas fa-save"></i>
        </button>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            let chapterCounter = 0;
            let questionCounter = 0;
            let examEnabled = false;
            let editingCourseId = null;
            let isEditMode = false;

            // Initialize
            document.addEventListener('DOMContentLoaded', function() {
                updateProgress();
                
                // Check if we should load a course for editing
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('course_id');
                if (courseId) {
                    document.getElementById('courseToEdit').value = courseId;
                    loadCourseForEdit();
                }
            });

            function loadCourseForEdit() {
                const courseSelect = document.getElementById('courseToEdit');
                const courseId = courseSelect.value;

                if (!courseId) {
                    // Reset to create mode
                    isEditMode = false;
                    editingCourseId = null;
                    resetForm();
                    showNotification('Режим создания нового курса', 'info');
                    return;
                }

                // Switch to edit mode
                isEditMode = true;
                editingCourseId = parseInt(courseId);
                showNotification('Загрузка курса для редактирования...', 'info');

                // Load course data from API
                fetch(`/api/course/${courseId}/data`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.course) {
                            populateCourseData(data.course);
                            showNotification('Курс загружен для редактирования', 'success');
                        } else {
                            showNotification('Ошибка загрузки курса: ' + (data.error || 'Неизвестная ошибка'), 'error');
                        }
                    })
                    .catch(error => {
                        showNotification('Ошибка загрузки курса: ' + error, 'error');
                        console.error('Error loading course:', error);
                    });
            }

            function resetForm() {
                // Clear all form fields
                document.getElementById('courseTitle').value = '';
                document.getElementById('courseDescription').value = '';
                document.getElementById('courseIntroduction').value = '';
                document.getElementById('courseConclusion').value = '';
                document.getElementById('courseType').value = 'revocable';

                // Clear chapters
                document.getElementById('chaptersContainer').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-book fa-3x mb-3"></i>
                        <p>Нажмите "Добавить главу" чтобы создать первую главу курса</p>
                    </div>
                `;
                chapterCounter = 0;

                // Clear exam
                examEnabled = false;
                document.getElementById('examContainer').style.display = 'none';
                document.getElementById('examToggle').innerHTML = '<i class="fas fa-plus"></i> Добавить экзамен';
                document.getElementById('examQuestions').innerHTML = `
                    <div class="text-center text-muted py-3">
                        <p>Добавьте вопросы для экзамена</p>
                    </div>
                `;

                // Reset certificate settings to defaults
                resetCertificateSettings();

                updateProgress();
            }

            function resetCertificateSettings() {
                document.getElementById('certificate-title').value = 'СЕРТИФИКАТ';
                document.getElementById('certificate-subtitle').value = 'о прохождении курса';
                document.getElementById('certificate-organization').value = 'SapaEdu';
                document.getElementById('certificate-logo-url').value = '';
                document.getElementById('certificate-background-url').value = '';
                document.getElementById('certificate-bg-color').value = '#ffffff';
                document.getElementById('certificate-primary-color').value = '#007bff';
                document.getElementById('certificate-secondary-color').value = '#6c757d';
                document.getElementById('certificate-accent-color').value = '#28a745';
                document.getElementById('certificate-border-style').value = 'modern';
                document.getElementById('certificate-layout-style').value = 'standard';
                document.getElementById('certificate-achievement-badge').value = 'graduation';
                document.getElementById('certificate-watermark-text').value = 'SapaEdu';
                document.getElementById('certificate-watermark-opacity').value = 10;
                document.getElementById('opacity-value').textContent = '10';
                document.getElementById('certificate-show-qr').checked = true;
                document.getElementById('certificate-achievement-text').value = 'Успешно завершен курс';
                document.getElementById('certificate-validity-text').value = 'Действителен на момент выдачи';
                document.getElementById('certificate-footer-text').value = '';
                document.getElementById('certificate-author-name').value = '';
                document.getElementById('certificate-author-position').value = '';
            }

            function populateCourseData(course) {
                // Populate basic info
                const titleInput = document.getElementById('courseTitle');
                const descInput = document.getElementById('courseDescription');
                const introInput = document.getElementById('courseIntroduction');
                const conclusionInput = document.getElementById('courseConclusion');
                const typeInput = document.getElementById('courseType');
                
                if (titleInput) titleInput.value = course.title || '';
                if (descInput) descInput.value = course.description || '';
                if (introInput) introInput.value = course.introduction || '';
                if (conclusionInput) conclusionInput.value = course.conclusion || '';
                if (typeInput) typeInput.value = course.course_type || 'revocable';

                // Clear existing chapters
                const chaptersContainer = document.getElementById('chaptersContainer');
                if (chaptersContainer) {
                    chaptersContainer.innerHTML = '';
                }
                chapterCounter = 0;

                // Populate chapters
                if (course.chapters && course.chapters.length > 0) {
                    course.chapters.forEach((chapterData, index) => {
                        addChapter();
                        const chapterId = chapterCounter;
                        
                        // Set chapter title
                        const chapterElement = document.getElementById(`chapter_${chapterId}`);
                        if (chapterElement) {
                            const titleInput = chapterElement.querySelector('input[type="text"]');
                            if (titleInput) {
                                titleInput.value = chapterData.title || '';
                            }
                        }

                        // Populate content blocks
                        const contentContainer = document.getElementById(`content_${chapterId}`);
                        if (contentContainer) {
                            // Clear placeholder
                            contentContainer.innerHTML = '';
                            
                            if (chapterData.content_blocks && chapterData.content_blocks.length > 0) {
                                chapterData.content_blocks.forEach(block => {
                                    // Validate block type
                                    const blockType = block.type || 'text';
                                    addContentBlock(chapterId, blockType);
                                    
                                    // Fill content block data
                                    const lastBlock = contentContainer.lastElementChild;
                                    if (lastBlock && block.content) {
                                        const inputs = lastBlock.querySelectorAll('input, textarea');
                                        
                                        console.log(`Loading block type: ${blockType}, content:`, block.content);
                                        
                                        // Fill inputs based on block type and content structure
                                        if (typeof block.content === 'object' && block.content !== null) {
                                            const contentValues = Object.values(block.content);
                                            
                                            if (blockType === 'text') {
                                                // For text blocks, field_0 is the text content
                                                if (inputs[0]) {
                                                    inputs[0].value = contentValues[0] || '';
                                                }
                                            } else if (blockType === 'image') {
                                                // For image blocks: field_0 is URL, field_1 is description
                                                if (inputs[0]) {
                                                    inputs[0].value = contentValues[0] || '';
                                                    previewImage(inputs[0], lastBlock.id);
                                                }
                                                if (inputs[1]) {
                                                    inputs[1].value = contentValues[1] || '';
                                                }
                                            } else if (blockType === 'video') {
                                                // For video blocks: field_0 is YouTube URL
                                                if (inputs[0]) {
                                                    inputs[0].value = contentValues[0] || '';
                                                    previewVideo(inputs[0], lastBlock.id);
                                                }
                                            } else if (blockType === 'file') {
                                                // For file blocks: field_0 is URL, field_1 is description
                                                if (inputs[0]) {
                                                    inputs[0].value = contentValues[0] || '';
                                                }
                                                if (inputs[1]) {
                                                    inputs[1].value = contentValues[1] || '';
                                                }
                                            }
                                        }
                                    }
                                });
                            } else {
                                // Show placeholder if no blocks
                                contentContainer.innerHTML = `
                                    <div class="text-muted text-center py-3">
                                        <small>Добавьте контент для главы</small>
                                    </div>
                                `;
                            }
                        }

                        // Set test checkbox and populate questions
                        const testCheckbox = document.getElementById(`hasTest_${chapterId}`);
                        if (testCheckbox && chapterData.has_test) {
                            testCheckbox.checked = true;
                            toggleChapterTest(chapterId);

                            if (chapterData.test_questions && chapterData.test_questions.length > 0) {
                                const questionsContainer = document.getElementById(`questions_${chapterId}`);
                                if (questionsContainer) {
                                    questionsContainer.innerHTML = '';
                                    
                                    chapterData.test_questions.forEach(questionData => {
                                        addChapterQuestion(chapterId);
                                        populateQuestionData(questionsContainer.lastElementChild, questionData);
                                    });
                                }
                            }
                        }
                    });
                }

                // Populate exam
                if (course.exam && course.exam.questions && course.exam.questions.length > 0) {
                    examEnabled = false;
                    toggleExam();
                    
                    document.getElementById('examPassingScore').value = course.exam.passing_score || 80;
                    document.getElementById('examTimeLimit').value = course.exam.time_limit || 15;
                    document.getElementById('examMaxAttempts').value = course.exam.max_attempts || 2;

                    const examQuestionsContainer = document.getElementById('examQuestions');
                    examQuestionsContainer.innerHTML = '';

                    course.exam.questions.forEach(questionData => {
                        addExamQuestion();
                        populateQuestionData(examQuestionsContainer.lastElementChild, questionData);
                    });
                }

                // Populate certificate settings
                if (course.certificate) {
                    loadCertificateData(course);
                }

                updateProgress();
            }

            function populateQuestionData(questionElement, questionData) {
                if (!questionElement || !questionData) return;

                // Set question text
                const questionTextarea = questionElement.querySelector('textarea');
                if (questionTextarea) {
                    questionTextarea.value = questionData.text || '';
                }

                // Set image URL
                const imageInput = questionElement.querySelector('input[placeholder*="URL изображения"]');
                if (imageInput && questionData.image) {
                    imageInput.value = questionData.image;
                    // Trigger preview
                    previewImage(imageInput, questionElement.id);
                }

                // Set question type radio buttons FIRST
                const questionId = questionElement.id;
                const singleRadio = questionElement.querySelector(`input[value="single"]`);
                const multipleRadio = questionElement.querySelector(`input[value="multiple"]`);
                
                if (questionData.type === 'multiple' && multipleRadio) {
                    multipleRadio.checked = true;
                } else if (singleRadio) {
                    singleRadio.checked = true;
                }
                
                // Update question type (changes radio/checkbox inputs)
                changeQuestionType(questionId);

                // Clear existing answers
                const answersContainer = questionElement.querySelector('.answers-container');
                if (answersContainer) {
                    answersContainer.innerHTML = '';

                    // Add answers
                    if (questionData.answers && questionData.answers.length > 0) {
                        const inputType = questionData.type === 'multiple' ? 'checkbox' : 'radio';
                        
                        questionData.answers.forEach((answer, idx) => {
                            const answerHtml = `
                                <div class="answer-option">
                                    <input type="${inputType}" name="${questionId}_correct" value="${idx}" class="form-check-input">
                                    <input type="text" class="form-control" placeholder="Вариант ответа ${idx + 1}" value="${answer || ''}">
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeAnswer(this)" ${questionData.answers.length <= 2 ? 'disabled' : ''}>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                            answersContainer.insertAdjacentHTML('beforeend', answerHtml);
                        });

                        // Now set correct answers AFTER all inputs are created
                        setTimeout(() => {
                            const allInputs = answersContainer.querySelectorAll('input[type="radio"], input[type="checkbox"]');
                            
                            if (questionData.type === 'multiple' && Array.isArray(questionData.correct_answer)) {
                                questionData.correct_answer.forEach(correctIdx => {
                                    if (allInputs[correctIdx]) {
                                        allInputs[correctIdx].checked = true;
                                    }
                                });
                            } else if (questionData.type === 'single' && typeof questionData.correct_answer === 'number') {
                                if (allInputs[questionData.correct_answer]) {
                                    allInputs[questionData.correct_answer].checked = true;
                                }
                            }
                        }, 50);
                    }

                    updateAnswerButtons(questionId);
                }
            }

            function updateProgress() {
                const title = document.getElementById('courseTitle').value;
                const chapters = document.querySelectorAll('.chapter-item').length;
                const exam = examEnabled;

                let progress = 0;
                if (title) progress += 30;
                if (chapters > 0) progress += 50;
                if (exam) progress += 20;

                document.getElementById('progressBar').style.width = progress + '%';
            }

            function addChapter() {
                chapterCounter++;
                const container = document.getElementById('chaptersContainer');

                // Remove placeholder
                const placeholder = container.querySelector('.text-center');
                if (placeholder) placeholder.remove();

                const chapterHtml = `
                    <div class="chapter-item" id="chapter_${chapterCounter}">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6><i class="fas fa-book me-2"></i>Глава ${chapterCounter}</h6>
                            <button class="btn btn-outline-danger btn-sm" onclick="removeChapter(${chapterCounter})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Название главы</label>
                            <input type="text" class="form-control" placeholder="Введите название главы" onchange="updateProgress()">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Контент</label>
                            <div class="btn-group mb-2 w-100" role="group">
                                <button class="btn btn-outline-primary" onclick="addContentBlock(${chapterCounter}, 'text')">
                                    <i class="fas fa-align-left"></i> Текст
                                </button>
                                <button class="btn btn-outline-warning" onclick="addContentBlock(${chapterCounter}, 'image')">
                                    <i class="fas fa-image"></i> Изображение
                                </button>
                                <button class="btn btn-outline-danger" onclick="addContentBlock(${chapterCounter}, 'video')">
                                    <i class="fab fa-youtube"></i> Видео
                                </button>
                                <button class="btn btn-outline-secondary" onclick="addContentBlock(${chapterCounter}, 'file')">
                                    <i class="fas fa-file"></i> Файл
                                </button>
                            </div>
                            <div class="content-blocks" id="content_${chapterCounter}">
                                <div class="text-muted text-center py-3">
                                    <small>Добавьте контент для главы</small>
                                </div>
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="hasTest_${chapterCounter}" onchange="toggleChapterTest(${chapterCounter})">
                            <label class="form-check-label" for="hasTest_${chapterCounter}">
                                Добавить тест к главе
                            </label>
                        </div>

                        <div class="test-container" id="test_${chapterCounter}" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="text-warning">Тест главы</h6>
                                <button class="btn btn-outline-warning btn-sm" onclick="addChapterQuestion(${chapterCounter})">
                                    <i class="fas fa-plus"></i> Добавить вопрос
                                </button>
                            </div>
                            <div class="chapter-questions" id="questions_${chapterCounter}">
                                <div class="text-center text-muted py-2">
                                    <small>Добавьте вопросы для теста</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', chapterHtml);
                updateProgress();
            }

            function removeChapter(id) {
                if (confirm('Удалить эту главу?')) {
                    document.getElementById(`chapter_${id}`).remove();

                    // Show placeholder if no chapters
                    const container = document.getElementById('chaptersContainer');
                    if (container.children.length === 0) {
                        container.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-book fa-3x mb-3"></i>
                                <p>Нажмите "Добавить главу" чтобы создать первую главу курса</p>
                            </div>
                        `;
                    }
                    updateProgress();
                }
            }

            function addContentBlock(chapterId, type) {
                const container = document.getElementById(`content_${chapterId}`);
                const placeholder = container.querySelector('.text-center');
                if (placeholder) placeholder.remove();

                const blockId = `block_${chapterId}_${Date.now()}`;
                let blockHtml = '';

                switch(type) {
                    case 'text':
                        blockHtml = `
                            <div class="content-block" id="${blockId}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted"><i class="fas fa-align-left"></i> Текстовый блок</small>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <textarea class="form-control" rows="3" placeholder="Введите текст (поддерживается HTML)"></textarea>
                            </div>
                        `;
                        break;
                    case 'image':
                        blockHtml = `
                            <div class="content-block" id="${blockId}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted"><i class="fas fa-image"></i> Изображение</small>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <input type="url" class="form-control mb-2" placeholder="URL изображения" onchange="previewImage(this, '${blockId}')">
                                <input type="text" class="form-control" placeholder="Описание изображения">
                                <div class="image-preview" id="${blockId}_preview"></div>
                            </div>
                        `;
                        break;
                    case 'video':
                        blockHtml = `
                            <div class="content-block" id="${blockId}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted"><i class="fab fa-youtube"></i> YouTube видео</small>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <input type="url" class="form-control" placeholder="https://www.youtube.com/watch?v=..." onchange="previewVideo(this, '${blockId}')">
                                <div class="image-preview" id="${blockId}_preview"></div>
                            </div>
                        `;
                        break;
                    case 'file':
                        blockHtml = `
                            <div class="content-block" id="${blockId}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted"><i class="fas fa-file"></i> Файл для скачивания</small>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeBlock('${blockId}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <input type="url" class="form-control mb-2" placeholder="Прямая ссылка на файл">
                                <input type="text" class="form-control" placeholder="Описание файла">
                            </div>
                        `;
                        break;
                }

                container.insertAdjacentHTML('beforeend', blockHtml);
            }

            function removeBlock(blockId) {
                document.getElementById(blockId).remove();
            }

            function toggleChapterTest(chapterId) {
                const checkbox = document.getElementById(`hasTest_${chapterId}`);
                const testContainer = document.getElementById(`test_${chapterId}`);
                testContainer.style.display = checkbox.checked ? 'block' : 'none';
            }

            function toggleExam() {
                const container = document.getElementById('examContainer');
                const button = document.getElementById('examToggle');

                examEnabled = !examEnabled;
                container.style.display = examEnabled ? 'block' : 'none';
                button.innerHTML = examEnabled ? 
                    '<i class="fas fa-minus"></i> Убрать экзамен' : 
                    '<i class="fas fa-plus"></i> Добавить экзамен';

                updateProgress();
            }

            function addChapterQuestion(chapterId) {
                addQuestion(`questions_${chapterId}`, `chapter_${chapterId}`);
            }

            function addExamQuestion() {
                addQuestion('examQuestions', 'exam');
            }

            function addQuestion(containerId, prefix) {
                const container = document.getElementById(containerId);
                const placeholder = container.querySelector('.text-center');
                if (placeholder) placeholder.remove();

                questionCounter++;
                const questionId = `${prefix}_question_${questionCounter}`;

                const questionHtml = `
                    <div class="question-item" id="${questionId}">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Вопрос ${container.children.length + 1}</h6>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeQuestion('${questionId}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Текст вопроса</label>
                            <textarea class="form-control" rows="2" placeholder="Введите вопрос"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Изображение (необязательно)</label>
                            <input type="url" class="form-control" placeholder="URL изображения" onchange="previewImage(this, '${questionId}')">
                            <div class="image-preview" id="${questionId}_preview"></div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label">Тип вопроса</label>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="${questionId}_type" id="${questionId}_single" value="single" checked onchange="changeQuestionType('${questionId}')">
                                    <label class="btn btn-outline-primary" for="${questionId}_single">Один ответ</label>
                                    <input type="radio" class="btn-check" name="${questionId}_type" id="${questionId}_multiple" value="multiple" onchange="changeQuestionType('${questionId}')">
                                    <label class="btn btn-outline-primary" for="${questionId}_multiple">Несколько</label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label">Варианты ответа</label>
                                <button class="btn btn-sm btn-outline-success" onclick="addAnswer('${questionId}')">
                                    <i class="fas fa-plus"></i> Добавить
                                </button>
                            </div>
                            <div class="answers-container" id="${questionId}_answers">
                                <div class="answer-option">
                                    <input type="radio" name="${questionId}_correct" value="0" class="form-check-input">
                                    <input type="text" class="form-control" placeholder="Вариант ответа 1">
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeAnswer(this)" disabled>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="answer-option">
                                    <input type="radio" name="${questionId}_correct" value="1" class="form-check-input">
                                    <input type="text" class="form-control" placeholder="Вариант ответа 2">
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeAnswer(this)" disabled>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', questionHtml);
            }

            function removeQuestion(questionId) {
                if (confirm('Удалить этот вопрос?')) {
                    document.getElementById(questionId).remove();
                }
            }

            function changeQuestionType(questionId) {
                const isMultiple = document.getElementById(`${questionId}_multiple`).checked;
                const answersContainer = document.getElementById(`${questionId}_answers`);
                if (!answersContainer) return;
                
                const answers = answersContainer.querySelectorAll('.answer-option');

                answers.forEach((answer, index) => {
                    const input = answer.querySelector('input[type="radio"], input[type="checkbox"]');
                    if (!input) return;
                    
                    const wasChecked = input.checked;
                    const newInput = document.createElement('input');

                    newInput.type = isMultiple ? 'checkbox' : 'radio';
                    newInput.name = `${questionId}_correct`;
                    newInput.value = index;
                    newInput.className = 'form-check-input';
                    
                    // Preserve checked state when switching to multiple choice
                    if (isMultiple && wasChecked) {
                        newInput.checked = true;
                    } else if (!isMultiple && wasChecked) {
                        // For single choice, keep first checked
                        const firstChecked = answersContainer.querySelector('input[type="radio"]:checked, input[type="checkbox"]:checked');
                        if (!firstChecked || firstChecked === input) {
                            newInput.checked = true;
                        }
                    }

                    input.parentNode.replaceChild(newInput, input);
                });
            }
            
            function updateQuestionType(questionId, type) {
                // Set the radio button
                const singleRadio = document.getElementById(`${questionId}_single`);
                const multipleRadio = document.getElementById(`${questionId}_multiple`);
                
                if (type === 'multiple' && multipleRadio) {
                    multipleRadio.checked = true;
                } else if (singleRadio) {
                    singleRadio.checked = true;
                }
                
                // Update the inputs
                changeQuestionType(questionId);
            }

            function addAnswer(questionId) {
                const container = document.getElementById(`${questionId}_answers`);
                const answerCount = container.children.length;
                const isMultiple = document.getElementById(`${questionId}_multiple`).checked;

                const answerHtml = `
                    <div class="answer-option">
                        <input type="${isMultiple ? 'checkbox' : 'radio'}" name="${questionId}_correct" value="${answerCount}" class="form-check-input">
                        <input type="text" class="form-control" placeholder="Вариант ответа ${answerCount + 1}">
                        <button class="btn btn-sm btn-outline-danger" onclick="removeAnswer(this)" disabled>
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', answerHtml);
                updateAnswerButtons(questionId);
            }

            function removeAnswer(button) {
                const container = button.closest('.answers-container');
                button.closest('.answer-option').remove();

                // Update answer indices
                const answers = container.querySelectorAll('.answer-option');
                answers.forEach((answer, index) => {
                    const input = answer.querySelector('input[type="radio"], input[type="checkbox"]');
                    const textInput = answer.querySelector('input[type="text"]');
                    input.value = index;
                    textInput.placeholder = `Вариант ответа ${index + 1}`;
                });

                // Update button states
                const questionId = container.id.replace('_answers', '');
                updateAnswerButtons(questionId);
            }

            function updateAnswerButtons(questionId) {
                const container = document.getElementById(`${questionId}_answers`);
                const buttons = container.querySelectorAll('button');
                buttons.forEach(button => {
                    button.disabled = container.children.length <= 2;
                });
            }

            function previewImage(input, blockId) {
                const preview = document.getElementById(`${blockId}_preview`);
                const url = input.value.trim();

                if (url) {
                    preview.innerHTML = `<img src="${url}" class="img-thumbnail mt-2" style="max-width: 300px; max-height: 200px;" onerror="this.style.display='none'">`;
                } else {
                    preview.innerHTML = '';
                }
            }

            function previewVideo(input, blockId) {
                const preview = document.getElementById(`${blockId}_preview`);
                const url = input.value.trim();

                if (url) {
                    const videoId = extractYouTubeId(url);
                    if (videoId) {
                        preview.innerHTML = `
                            <iframe width="300" height="200" 
                                    src="https://www.youtube.com/embed/${videoId}" 
                                    frameborder="0" allowfullscreen class="mt-2">
                            </iframe>
                        `;
                    } else {
                        preview.innerHTML = '<div class="text-danger mt-2">Некорректная ссылка YouTube</div>';
                    }
                } else {
                    preview.innerHTML = '';
                }
            }

            function extractYouTubeId(url) {
                const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[7].length === 11) ? match[7] : null;
            }

            function collectCourseData() {
                const courseData = {
                    title: document.getElementById('courseTitle').value.trim(),
                    description: document.getElementById('courseDescription').value.trim(),
                    introduction: document.getElementById('courseIntroduction').value.trim(),
                    conclusion: document.getElementById('courseConclusion').value.trim(),
                    course_type: document.getElementById('courseType').value,
                    chapters: [],
                    exam: null,
                    certificate: {
                        title: "СЕРТИФИКАТ",
                        subtitle: "о прохождении курса",
                        organization: "SapaEdu",
                        status: "active"
                    }
                };

                // Collect chapters
                const chapters = document.querySelectorAll('.chapter-item');
                chapters.forEach((chapter, index) => {
                    const chapterData = {
                        title: chapter.querySelector('input[type="text"]').value || `Глава ${index + 1}`,
                        content_blocks: [],
                        has_test: chapter.querySelector('input[type="checkbox"]').checked,
                        test_questions: []
                    };

                    // Collect content blocks
                    const blocks = chapter.querySelectorAll('.content-block');
                    blocks.forEach(block => {
                        const inputs = block.querySelectorAll('input, textarea');
                        const blockData = {
                            type: block.id.includes('text') ? 'text' : 
                                  block.id.includes('image') ? 'image' : 
                                  block.id.includes('video') ? 'video' : 'file',
                            content: {}
                        };

                        inputs.forEach((input, idx) => {
                            blockData.content[`field_${idx}`] = input.value.trim();
                        });

                        chapterData.content_blocks.push(blockData);
                    });

                    // Collect chapter test questions
                    if (chapterData.has_test) {
                        const questions = chapter.querySelectorAll('.question-item');
                        questions.forEach(question => {
                            const questionData = collectQuestionData(question);
                            if (questionData) chapterData.test_questions.push(questionData);
                        });
                    }

                    courseData.chapters.push(chapterData);
                });

                // Collect exam data
                if (examEnabled) {
                    const examQuestions = [];
                    const questions = document.querySelectorAll('#examQuestions .question-item');
                    questions.forEach(question => {
                        const questionData = collectQuestionData(question);
                        if (questionData) examQuestions.push(questionData);
                    });

                    if (examQuestions.length > 0) {
                        courseData.exam = {
                            questions: examQuestions,
                            passing_score: parseInt(document.getElementById('examPassingScore').value) || 80,
                            time_limit: parseInt(document.getElementById('examTimeLimit').value) || 15,
                            max_attempts: parseInt(document.getElementById('examMaxAttempts').value) || 2
                        };
                    }
                }

                // Collect certificate data
                const certificateData = {
                    title: document.getElementById('certificate-title').value || 'СЕРТИФИКАТ',
                    subtitle: document.getElementById('certificate-subtitle').value || 'о прохождении курса',
                    organization: document.getElementById('certificate-organization').value || 'SapaEdu',
                    logo_url: document.getElementById('certificate-logo-url').value || '',
                    background_url: document.getElementById('certificate-background-url').value || '',
                    background_color: document.getElementById('certificate-bg-color').value || '#ffffff',
                    primary_color: document.getElementById('certificate-primary-color').value || '#007bff',
                    secondary_color: document.getElementById('certificate-secondary-color').value || '#6c757d',
                    accent_color: document.getElementById('certificate-accent-color').value || '#28a745',
                    border_style: document.getElementById('certificate-border-style').value || 'modern',
                    layout_style: document.getElementById('certificate-layout-style').value || 'standard',
                    achievement_badge: document.getElementById('certificate-achievement-badge').value || 'graduation',
                    watermark_text: document.getElementById('certificate-watermark-text').value || 'SapaEdu',
                    watermark_opacity: parseFloat(document.getElementById('certificate-watermark-opacity').value || 10) / 100,
                    show_qr: document.getElementById('certificate-show-qr').checked,
                    achievement_text: document.getElementById('certificate-achievement-text').value || 'Успешно завершен курс',
                    validity_text: document.getElementById('certificate-validity-text').value || 'Действителен на момент выдачи',
                    footer_text: document.getElementById('certificate-footer-text').value || '',
                    author_name: document.getElementById('certificate-author-name').value || '',
                    author_position: document.getElementById('certificate-author-position').value || ''
                };
                courseData.certificate = certificateData;

                return courseData;
            }

            function collectQuestionData(questionElement) {
                const questionText = questionElement.querySelector('textarea').value.trim();
                if (!questionText) return null;

                const imageUrl = questionElement.querySelector('input[placeholder*="URL изображения"]').value.trim();
                const isMultiple = questionElement.querySelector('input[value="multiple"]:checked');

                const answers = [];
                const answerInputs = questionElement.querySelectorAll('.answer-option input[type="text"]');
                answerInputs.forEach(input => {
                    if (input.value.trim()) answers.push(input.value.trim());
                });

                if (answers.length < 2) return null;

                let correctAnswer = [];
                if (isMultiple) {
                    const checkedInputs = questionElement.querySelectorAll('.answer-option input[type="checkbox"]:checked');
                    checkedInputs.forEach(input => correctAnswer.push(parseInt(input.value)));
                } else {
                    const checkedInput = questionElement.querySelector('.answer-option input[type="radio"]:checked');
                    correctAnswer = checkedInput ? parseInt(checkedInput.value) : 0;
                }

                return {
                    text: questionText,
                    image: imageUrl,
                    type: isMultiple ? 'multiple' : 'single',
                    answers: answers,
                    correct_answer: correctAnswer
                };
            }

            function saveDraft() {
                saveCourse(false);
            }

            function publishCourse() {
                saveCourse(true);
            }

            function saveCourse(isPublished) {
                const courseData = collectCourseData();

                if (!courseData.title) {
                    showNotification('Введите название курса', 'error');
                    document.getElementById('courseTitle').focus();
                    return;
                }

                courseData.is_published = isPublished;

                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';
                button.disabled = true;

                // Determine if we're creating or updating
                const apiUrl = isEditMode && editingCourseId 
                    ? `/api/course/${editingCourseId}/update`
                    : '/api/create-course';
                
                const actionVerb = isEditMode ? 'обновлен' : (isPublished ? 'опубликован' : 'сохранен как черновик');

                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(courseData)
                })
                .then(response => response.json())
                .then(data => {
                    button.innerHTML = originalText;
                    button.disabled = false;

                    if (data.success) {
                        showNotification(`Курс успешно ${actionVerb}!`, 'success');

                        // Update editing state if we just created a new course
                        if (!isEditMode && data.course_id) {
                            isEditMode = true;
                            editingCourseId = data.course_id;
                        }

                        setTimeout(() => {
                            window.location.href = '{{ url_for("admin_courses") }}';
                        }, 2000);
                    } else {
                        showNotification('Ошибка: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    showNotification('Ошибка сети при сохранении', 'error');
                });
            }

            function previewCourse() {
                const courseData = collectCourseData();
                if (!courseData.title) {
                    showNotification('Введите название курса для предпросмотра', 'error');
                    return;
                }

                // Создаем предпросмотр сертификата
                previewCertificate(courseData);
            }

            function previewCertificate(courseData) {
                // Create preview modal
                const courseTitle = document.getElementById('courseTitle').value || 'Название курса';
                const previewHtml = `
                    <div class="certificate-preview" style="
                        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                        border: 8px solid #3b82f6;
                        border-radius: 20px;
                        padding: 40px;
                        position: relative;
                        min-height: 500px;
                        overflow: hidden;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    ">
                        <!-- Watermark -->
                        <div style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%) rotate(-45deg);
                            font-size: 4rem;
                            font-weight: 900;
                            color: rgba(59, 130, 246, 0.03);
                            z-index: 1;
                            user-select: none;
                            text-transform: uppercase;
                            letter-spacing: 1rem;
                        ">SapaEdu</div>

                        <!-- Header -->
                        <div style="position: relative; z-index: 2;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
                                <div style="
                                    width: 60px;
                                    height: 60px;
                                    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-size: 1.5rem;
                                    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
                                ">🎓</div>
                                <div style="text-align: right;">
                                    <h4 style="color: #3b82f6; margin: 0; font-size: 1.2rem;">SapaEdu</h4>
                                    <p style="color: #6c757d; margin: 0; font-size: 0.9rem;">Платформа корпоративного обучения</p>
                                </div>
                            </div>

                            <!-- Main Content -->
                            <div style="text-align: center;">
                                <h1 style="
                                    color: #3b82f6;
                                    font-size: 3rem;
                                    font-weight: 900;
                                    margin: 30px 0 15px 0;
                                    letter-spacing: 0.3rem;
                                    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
                                ">СЕРТИФИКАТ</h1>

                                <div style="
                                    width: 200px;
                                    height: 4px;
                                    background: linear-gradient(90deg, transparent, #3b82f6, transparent);
                                    margin: 0 auto 15px;
                                    border-radius: 2px;
                                "></div>

                                <h3 style="
                                    color: #6c757d;
                                    font-style: italic;
                                    margin-bottom: 30px;
                                    font-weight: 300;
                                ">о прохождении курса</h3>

                                <div style="
                                    border: 2px solid #3b82f6;
                                    border-radius: 10px;
                                    padding: 15px;
                                    margin: 25px auto;
                                    max-width: 80%;
                                    background: rgba(59, 130, 246, 0.05);
                                ">
                                    <strong style="color: #3b82f6; font-size: 1.5rem;">"${courseTitle}"</strong>
                                </div>

                                <p style="color: #6c757d; margin: 30px 0 10px 0;">выдан</p>
                                <h2 style="
                                    color: #3b82f6;
                                    font-weight: bold;
                                    margin: 0 0 15px 0;
                                    font-size: 2.2rem;
                                ">Имя Получателя</h2>

                                <div style="
                                    width: 300px;
                                    height: 2px;
                                    background: linear-gradient(90deg, transparent, #10b981, transparent);
                                    margin: 0 auto 25px;
                                "></div>

                                <div style="margin: 25px 0;">
                                    <div style="
                                        width: 70px;
                                        height: 70px;
                                        border-radius: 50%;
                                        background: linear-gradient(135deg, #10b981, #059669);
                                        display: inline-flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 2rem;
                                        margin-bottom: 15px;
                                        box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
                                    ">🎓</div>
                                    <p style="
                                        color: #10b981;
                                        font-weight: 600;
                                        margin: 0;
                                        font-size: 1.2rem;
                                        text-transform: uppercase;
                                        letter-spacing: 1px;
                                    ">Успешно завершен курс</p>
                                </div>

                                ${courseData.certificate.author_name ? `
                                <div style="margin: 20px 0; text-align: center;">
                                    <div style="
                                        width: 200px;
                                        height: 2px;
                                        background: #6c757d;
                                        margin: 0 auto 8px;
                                    "></div>
                                    <div style="font-weight: bold; color: #2c3e50; margin-bottom: 3px;">${courseData.certificate.author_name}</div>
                                    ${courseData.certificate.author_position ? `<div style="font-size: 0.85rem; color: #6c757d; font-style: italic;">${courseData.certificate.author_position}</div>` : ''}
                                </div>
                                ` : ''}

                                ${courseData.certificate.footer_text ? `
                                <div style="margin-top: 20px; font-size: 0.9rem; color: #6c757d;">
                                    ${courseData.certificate.footer_text}
                                </div>
                                ` : ''}
                            </div>

                            <!-- Footer -->
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: flex-end;
                                margin-top: 30px;
                                font-size: 0.9rem;
                            ">
                                <div>
                                    <div><strong>Код:</strong> <span style="background: #f8f9fa; padding: 3px 8px; border-radius: 4px; border: 1px solid #3b82f6;">ABC123</span></div>
                                    <div style="margin-top: 5px;"><strong>Дата:</strong> ${new Date().toLocaleDateString('ru-RU')}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="
                                        width: 60px;
                                        height: 60px;
                                        background: white;
                                        border: 2px solid #6c757d;
                                        border-radius: 4px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 0.7rem;
                                        color: #6c757d;
                                        margin: 0 auto 5px;
                                    ">QR</div>
                                    <small style="color: #6c757d;">Проверить</small>
                                </div>
                            </div>
                        </div>

                        <!-- Status Badge -->
                        <div style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            padding: 8px 15px;
                            border-radius: 20px;
                            font-weight: bold;
                            font-size: 0.8rem;
                            box-shadow: 0 3px 10px rgba(16, 185, 129, 0.4);
                        ">✓ ДЕЙСТВИТЕЛЕН</div>
                    </div>
                `;

                // Показываем в модальном окне
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    max-width: 90vw;
                    max-height: 90vh;
                    overflow: auto;
                    position: relative;
                `;

                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '×';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 15px;
                    background: none;
                    border: none;
                    font-size: 2rem;
                    color: #666;
                    cursor: pointer;
                    z-index: 10000;
                `;
                closeBtn.onclick = () => modal.remove();

                const title = document.createElement('h3');
                title.textContent = 'Предпросмотр сертификата';
                title.style.cssText = 'margin: 0 0 20px 0; text-align: center; color: #333;';

                modalContent.appendChild(closeBtn);
                modalContent.appendChild(title);
                modalContent.innerHTML += previewHtml;
                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Закрытие по клику вне модального окна
                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };
            }

            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
                `;

                document.body.appendChild(notification);

                setTimeout(() => notification.classList.add('show'), 100);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }

            // Auto-save functionality
            let autoSaveTimer;
            document.addEventListener('input', () => {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    updateProgress();
                }, 1000);
            });

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });

            // Handle opacity slider
            const opacitySlider = document.getElementById('certificate-watermark-opacity');
            const opacityValue = document.getElementById('opacity-value');

            if (opacitySlider && opacityValue) {
                opacitySlider.addEventListener('input', function() {
                    opacityValue.textContent = this.value;
                });
            }

            function previewCertificate() {
                const certificateData = {
                    title: document.getElementById('certificate-title').value || 'СЕРТИФИКАТ',
                    subtitle: document.getElementById('certificate-subtitle').value || 'о прохождении курса',
                    organization: document.getElementById('certificate-organization').value || 'SapaEdu',
                    background_color: document.getElementById('certificate-bg-color').value || '#ffffff',
                    primary_color: document.getElementById('certificate-primary-color').value || '#007bff',
                    secondary_color: document.getElementById('certificate-secondary-color').value || '#6c757d',
                    accent_color: document.getElementById('certificate-accent-color').value || '#28a745',
                    border_style: document.getElementById('certificate-border-style').value || 'modern',
                    achievement_badge: document.getElementById('certificate-achievement-badge').value || 'graduation',
                    watermark_text: document.getElementById('certificate-watermark-text').value || 'SapaEdu',
                    watermark_opacity: parseFloat(document.getElementById('certificate-watermark-opacity').value || 10) / 100,
                    achievement_text: document.getElementById('certificate-achievement-text').value || 'Успешно завершен курс'
                };

                // Create preview modal
                const previewHtml = `
                    <div class="modal fade" id="certificatePreviewModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Предварительный просмотр сертификата</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="certificate-preview" style="
                                        background-color: ${certificateData.background_color};
                                        border: 8px solid ${certificateData.primary_color};
                                        border-radius: 15px;
                                        padding: 40px;
                                        position: relative;
                                        min-height: 500px;
                                        overflow: hidden;
                                    ">
                                        <div style="
                                            position: absolute;
                                            top: 50%;
                                            left: 50%;
                                            transform: translate(-50%, -50%) rotate(-45deg);
                                            font-size: 4rem;
                                            font-weight: bold;
                                            color: ${certificateData.secondary_color};
                                            opacity: ${certificateData.watermark_opacity};
                                            z-index: 1;
                                            user-select: none;
                                        ">${certificateData.watermark_text}</div>

                                        <div style="position: relative; z-index: 2; text-align: center;">
                                            <div style="margin-bottom: 20px;">
                                                <h4 style="color: ${certificateData.primary_color}; margin: 0;">${certificateData.organization}</h4>
                                                <small style="color: ${certificateData.secondary_color};">Платформа корпоративного обучения</small>
                                            </div>

                                            <h1 style="
                                                color: ${certificateData.primary_color};
                                                font-size: 3rem;
                                                font-weight: bold;
                                                margin: 30px 0;
                                            ">${certificateData.title}</h1>

                                            <h3 style="
                                                color: ${certificateData.secondary_color};
                                                font-style: italic;
                                                margin-bottom: 30px;
                                            ">${certificateData.subtitle}</h3>

                                            <div style="
                                                border: 3px solid ${certificateData.primary_color};
                                                border-radius: 10px;
                                                padding: 15px;
                                                margin: 30px auto;
                                                max-width: 80%;
                                                background: rgba(0,123,255,0.05);
                                            ">
                                                <strong style="color: ${certificateData.primary_color};">"Название курса"</strong>
                                            </div>

                                            <p style="color: ${certificateData.secondary_color}; margin: 20px 0;">выдан</p>
                                            <h2 style="
                                                color: ${certificateData.primary_color};
                                                font-weight: bold;
                                                margin: 20px 0;
                                            ">Имя Получателя</h2>

                                            <div style="margin: 30px 0;">
                                                <div style="
                                                    width: 80px;
                                                    height: 80px;
                                                    border-radius: 50%;
                                                    background: ${certificateData.accent_color};
                                                    display: inline-flex;
                                                    align-items: center;
                                                    justify-content: center;
                                                    color: white;
                                                    font-size: 2rem;
                                                    margin-bottom: 15px;
                                                ">
                                                    ${getBadgeIcon(certificateData.achievement_badge)}
                                                </div>
                                                <p style="
                                                    color: ${certificateData.accent_color};
                                                    font-weight: 600;
                                                    margin: 0;
                                                ">${certificateData.achievement_text}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if present
                const existingModal = document.getElementById('certificatePreviewModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', previewHtml);

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('certificatePreviewModal'));
                modal.show();
            }

            function getBadgeIcon(badgeType) {
                switch (badgeType) {
                    case 'shield': return '🛡️';
                    case 'star': return '⭐';
                    case 'trophy': return '🏆';
                    default: return '🎓';
                }
            }

            // Load certificate data
            function loadCertificateData(courseData) {
                if (courseData.certificate) {
                    const cert = courseData.certificate;
                    const setIfExists = (id, value) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.value = value;
                    };
                    const setCheckedIfExists = (id, value) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.checked = value;
                    };
                    const setTextIfExists = (id, value) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.textContent = value;
                    };
                    
                    setIfExists('certificate-title', cert.title || 'СЕРТИФИКАТ');
                    setIfExists('certificate-subtitle', cert.subtitle || 'о прохождении курса');
                    setIfExists('certificate-organization', cert.organization || 'SapaEdu');
                    setIfExists('certificate-logo-url', cert.logo_url || '');
                    setIfExists('certificate-background-url', cert.background_url || '');
                    setIfExists('certificate-bg-color', cert.background_color || '#ffffff');
                    setIfExists('certificate-primary-color', cert.primary_color || '#007bff');
                    setIfExists('certificate-secondary-color', cert.secondary_color || '#6c757d');
                    setIfExists('certificate-accent-color', cert.accent_color || '#28a745');
                    setIfExists('certificate-border-style', cert.border_style || 'modern');
                    setIfExists('certificate-layout-style', cert.layout_style || 'standard');
                    setIfExists('certificate-achievement-badge', cert.achievement_badge || 'graduation');
                    setIfExists('certificate-watermark-text', cert.watermark_text || 'SapaEdu');
                    setIfExists('certificate-watermark-opacity', (cert.watermark_opacity || 0.1) * 100);
                    setTextIfExists('opacity-value', Math.round((cert.watermark_opacity || 0.1) * 100));
                    setCheckedIfExists('certificate-show-qr', cert.show_qr !== false);
                    setIfExists('certificate-achievement-text', cert.achievement_text || 'Успешно завершен курс');
                    setIfExists('certificate-validity-text', cert.validity_text || 'Действителен на момент выдачи');
                    setIfExists('certificate-footer-text', cert.footer_text || '');
                    setIfExists('certificate-author-name', cert.author_name || '');
                    setIfExists('certificate-author-position', cert.author_position || '');
                }
            }

            // Initial loading of data if available (e.g., when editing an existing course)
            // This part would typically involve fetching course data and then calling loadCertificateData
            // For this example, we assume courseData might be available globally or passed in.
            // Example:
            // if (typeof initialCourseData !== 'undefined') {
            //     loadCourseData(initialCourseData); // Assuming a function to load all course data
            // }


        </script>
    </body>
</html>